/* Copyright (C) 2010 Ion Torrent Systems, Inc. All Rights Reserved */
#include <gtest/gtest.h>
#include <vector>
#include "FindSlopeChange.h"
#include "Utils.h"
#include "T0Model.h"
#include "Stats.h"

TEST(T0Model_Test, SegmentFitterTest) {
  float yvals[] = {0,1,2,3,4};
  float xvals[] = {0,1,2,3,4};
  LineModel sf;
  sf.FitModel(&yvals[0], &yvals[0] + 5, &xvals[0], &xvals[0] + 5);
  Col<float> prediction;
  sf.GetPrediction(prediction);
  for (size_t i = 0; i < prediction.n_rows; i++) {
    ASSERT_NEAR(prediction.at(i), i, .001);
  }
  ASSERT_NEAR(sf.SumSqErr(), 0, .0001);
}

TEST(T0Model_Test, T0FinderTest) {
  //  float yvals[] = {0,-0.325926,-0.937037,-1.54815,-2.17407,-2.8,-3.12593,-3.37037,-3.76296,-4.00741,-4.31852,-4.57778,-4.44074,-4.32222,-4.89259,-5.64444,-7.58889,-10.6704,-10.137,-6.66296,-3.7037,-2.07778,-0.618519,1.4,4.17778,7.67037,11.4333,15.163,14.7185,8.12963,-7.56296,-37.0259,-89.0296,-177.522,-323.696,-543.819,-834.726,-1178.87,-1551.51,-1933.76,-2307.1,-2660.14,-2978.72,-3253.29,-3482.33,-3669.13,-3822.49,-3952.26,-4064.52,-4163.15,-4250.39,-4327,-4394.18,-4454.1,-4509.66,-4558.39,-4601.8,-4641.9,-4677.85,-4710.32,-4739.09,-4765.88,-4789.59,-4811.23,-4830.96,-4847.48,-4862.96,-4875.26,-4875.26,-4875.26,-4875.26,-4875.26,-4875.26};
  float yvals[] = {0,-13.5135,-5.40541,24.3243,2.7027,5.40541,13.5135,13.5135,-8.10811,13.5135,10.8108,-5.40541,21.6216,5.40541,24.3243,40.5405,102.703,172.973,259.459,367.568,424.324,475.676,494.595,21.6216,-1275.68,-2902.7,-4286.49,-5478.38,-6410.81,-7324.32,-8016.22,-8648.65,-9186.49,-9724.32,-10129.7,-10516.2,-10900,-11208.1,-11473,-11743.2,-11978.4,-12183.8,-12394.6,-12562.2,-12654.1,-12810.8,-12913.5,-13032.4,-13094.6,-13194.6,-13259.5,-13327,-13416.2,-13454.1,-13502.7,-13529.7,-13578.4,-13567.6,-13605.4,-13643.2,-13637.8,-13697.3,-13681.1,-13694.6,-13705.4,-13727,-13710.8,-13745.9,-13748.6,-13716.2,-13729.7,-13735.1,-13745.9,-13754.1,-13743.2,-13767.6,-13773,-13810.8,-13824.3,-13813.5,-13854.1,-13745.9,-13610.8,-13421.6,-13181.1,-12986.5,-12756.8,-12567.6,-12318.9,-12094.6,-11900,-11664.9,-11462.2,-11256.8,-11048.6,-10827,-10651.4,-10443.2,-10270.3,-10113.5,-9916.22,-9754.05,-9567.57,-9410.81,-9227.03};
  size_t size = sizeof(yvals)/sizeof(float);

  T0Finder t0;
  t0.SetWindowSize(4);
  t0.SetFirstSlopeRange(-1,30);
  t0.SetSecondSlopeRange(-1000.0,-10.0);
  t0.SetSearchRange(0,size);
  t0.FindT0(yvals, size);
  float t0Est = t0.GetT0Est();
  cout << "T0 is: " << t0Est << endl;
}

TEST(KS_Test, KSTest) {
  double x[20] = {1.63313947694582,1.98159218483095,2.30817665207901,0.643189185901684,2.10025056281594,2.47586865415744,3.06863804435182,1.7260154408842,0.562146436342725,1.06251879607389,2.46162218590124,2.27683738338566,3.09312499042475,1.29859109720064,2.15682005864203,1.58274927217625,2.7680121379595,2.79032218491736,3.88805948905098,-0.247026288372596};
  double xx[20] = {1.63313947694582,1.98159218483095,2.30817665207901,0.643189185901684,2.10025056281594,2.47586865415744,3.06863804435182,1.7260154408842,0.562146436342725,1.06251879607389,2.46162218590124,2.27683738338566,3.09312499042475,1.29859109720064,2.15682005864203,1.58274927217625,2.7680121379595,2.79032218491736,3.88805948905098,-0.247026288372596};
  double y[10] = {1.53246420166323,0.876105335156119,0.811748442850538,1.87816204590939,0.662621204817235,-0.345524189861815,1.69780996101758,1.5718325282617,-0.123437463087946,0.999034571505837};

  std::sort(&x[0], &x[0] + 20);
  std::sort(&xx[0], &xx[0] + 20);
  std::sort(&y[0], &y[0] + 10);
  for(int n = 0; n < 20; n++) {
    x[n] = xx[n] * .48;
  }
  double p1,d1;
  d1 = ionStats::KolmogorovTest(20, x, 10, y, 1);
  p1 = ionStats::SmirnovK(10,d1);
  ASSERT_NEAR(0.20000000000000001,d1,.001);
  ASSERT_NEAR(0.74871903999999989,p1,.001);
  // for (double i = 1; i >= 0; i -= .01) {
  //   for(int n = 0; n < 20; n++) {
  //     x[n] = xx[n] * i;
  //   } 
  //   d1 = ionStats::KolmogorovTest(20, x, 10, y, 1);
  //   p1 = ionStats::K(10,d1);
  //   cout << i << "\t" << p1 << "\t" << d1 << endl;
  // }

  d1 = ionStats::KolmogorovTest(20, xx, 10, y, 1);
  p1 = ionStats::SmirnovK(10,d1);
  ASSERT_NEAR(0.59999999999999998, d1,.001);
  ASSERT_NEAR(0.00056816720000019139, p1,.001);
  //  cout << "1.0 P1: " << p1 << "\t" << d1 << endl;
}

