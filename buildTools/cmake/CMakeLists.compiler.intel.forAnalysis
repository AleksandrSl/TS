# Copyright (C) 2010 Ion Torrent Systems, Inc. All Rights Reserved
# replace ../../../Analysis/CMakeLists.txt with this file to use
# the Intel compiler
cmake_minimum_required (VERSION 2.6)
project (ion-analysis)
set(PROJECT_DESCRIPTION "Ion Torrent Data Processing Pipeline")
enable_testing()

option(ION_DO_BACKGROUND "Build with background model" ON)
mark_as_advanced(ION_DO_BACKGROUND)

option(ION_USE_CUDA "Compile CUDA code" OFF)
mark_as_advanced(ION_USE_CUDA)

option(ION_USE_SYSTEM_CUDA "Use CUDA system libraries" OFF)
mark_as_advanced(ION_USE_SYSTEM_CUDA)

option(ION_USE_SYSTEM_SAMTOOLS "Use samtools system libraries" OFF)
mark_as_advanced(ION_USE_SYSTEM_SAMTOOLS)

option(ION_USE_SYSTEM_FFTW "Use fftw system libraries" OFF)
mark_as_advanced(ION_USE_SYSTEM_FFTW)

option(ION_USE_SYSTEM_HDF5 "Use hdf5 system libraries" OFF)
mark_as_advanced(ION_USE_SYSTEM_HDF5)

option(ION_USE_SYSTEM_ARMADILLO "Use armadillo system libraries" OFF)
mark_as_advanced(ION_USE_SYSTEM_ARMADILLO)

option(ION_USE_SYSTEM_BOOST "Use boost system libraries" ON)
mark_as_advanced(ION_USE_SYSTEM_BOOST)

option(ION_USE_SYSTEM_UNWIND "Use unwind system libraries" OFF)
mark_as_advanced(ION_USE_SYSTEM_UNWIND)

if(NOT CMAKE_SYSTEM_NAME STREQUAL "Darwin")
    set(ION_DO_BACKGROUND OFF CACHE BOOL "Build with background model")
endif()

set(ICC OFF)

if(${CMAKE_CXX_COMPILER} MATCHES "icpc")
  set(ICC ON)
endif()

if(ICC)
  message(STATUS "Using Intel Compiler")
endif()

include(../buildTools/cmake/CMakeLists.version.txt)
#set(CMAKE_BUILD_TYPE Debug)
if(ICC)
#set(CMAKE_BUILD_TYPE Debug)
  include(../buildTools/cmake/CMakeLists.compiler.intel.txt)
else()
  include(../buildTools/cmake/CMakeLists.compiler.txt)
endif()

option(USE_MKL "Using Intel MKL" OFF)
mark_as_advanced(USE_MKL)

set(CMAKE_MODULE_PATH ${CMAKE_MODULE_PATH} "${CMAKE_SOURCE_DIR}/../buildTools/cmake/Modules")

if (ICC)
  find_package(MKL REQUIRED)
endif()

if(USE_MKL)
  add_definitions(-DION_USE_MKL)
  include_directories(${MKL_INCLUDE_DIRS})
  message(STATUS "Using Intel MKL")
endif()

#custom ExternalProject_add with timeout feature
IF (${CMAKE_MAJOR_VERSION}.${CMAKE_MINOR_VERSION}.${CMAKE_PATCH_VERSION} STRLESS 2.8.1)
  SET(CMAKE_MODULE_PATH
    ${CMAKE_MODULE_PATH}
    ${CMAKE_CURRENT_SOURCE_DIR}/CMake
  )
ENDIF ()
include(ExternalProject)

if(ION_USE_CUDA)
  message(STATUS "BUILD with CUDA")
  add_definitions(-DION_COMPILE_CUDA)
endif()

# Where to install - override with: -DION_INSTALL_PREFIX
set(ION_INSTALL_PREFIX "/opt/ion" CACHE PATH "Ion Install Prefix")

set(ION_UPDATE_SERVER "updates.iontorrent.com") # internal developer can use just "updates"

set(CPACK_PACKAGING_INSTALL_PREFIX ${ION_INSTALL_PREFIX})
set(CPACK_SET_DESTDIR "ON")

configure_file (
    "${PROJECT_SOURCE_DIR}/debian/postinst.in"
    "${PROJECT_BINARY_DIR}/debian/postinst" @ONLY
)
configure_file (
    "${PROJECT_SOURCE_DIR}/debian/prerm.in"
    "${PROJECT_BINARY_DIR}/debian/prerm" @ONLY
)

set (ION_TS_EXTERNAL "${PROJECT_SOURCE_DIR}/../external/")
#set (ION_TS_EXTERNAL "${CMAKE_BINARY_DIR}/external/")

find_program(LSB_RELEASE_COMMAND lsb_release)
if(LSB_RELEASE_COMMAND)
    execute_process(COMMAND ${LSB_RELEASE_COMMAND} -s -c
        OUTPUT_VARIABLE TMP_LSB_RELEASE_CODENAME
        OUTPUT_STRIP_TRAILING_WHITESPACE)
    string(TOLOWER ${TMP_LSB_RELEASE_CODENAME} LSB_RELEASE_CODENAME)
    message(STATUS "LSB release codename: ${LSB_RELEASE_CODENAME}")
endif(LSB_RELEASE_COMMAND) 

if(ION_USE_CUDA)
    if (NOT ION_USE_SYSTEM_CUDA)

        set(proj_name "cudatoolkit")
        if (${LSB_RELEASE_CODENAME} STREQUAL "oneiric")
            set(proj_version "4.2.9-11.04")
            set(cuda_tar_file "cudatoolkit_4.2.9_linux_64_ubuntu11.04.tar.gz")
            set(CUDA_VERSION "4.2")
        else()
            set(proj_version "4.0.0RC")
            set(cuda_tar_file "cudatoolkit-4.0.0RC.tar.gz")
            set(CUDA_VERSION "4.0")
        endif()
        set(proj_name_version "${proj_name}-${proj_version}")

        set(CUDA_TOOLKIT_ROOT_DIR "${ION_TS_EXTERNAL}/${proj_name_version}/src/cudatoolkit/")
        set(CUDA_INCLUDE_DIRS "${ION_TS_EXTERNAL}/${proj_name_version}/src/cudatoolkit/include")
        set(CUDA_NVCC_EXECUTABLE "${ION_TS_EXTERNAL}/${proj_name_version}/src/cudatoolkit/bin/nvcc")
        set(CUDA_CUDART_LIBRARY "${ION_TS_EXTERNAL}/${proj_name_version}/src/cudatoolkit/lib64/libcudart.so")
        set(CUDA_TOOLKIT_INCLUDE "${ION_TS_EXTERNAL}/${proj_name_version}/src/cudatoolkit/include")
        set(CUDA_cublas_LIBRARY "${ION_TS_EXTERNAL}/${proj_name_version}/src/cudatoolkit/lib64/libcublas.so")
        set(CUDA_cufft_LIBRARY "${ION_TS_EXTERNAL}/${proj_name_version}/src/cudatoolkit/lib64/libcufft.so")
        set(CUDA_VERBOSE_BUILD OFF)
        set(CUDA_64_BIT_DEVICE_CODE ON)
        include(${CMAKE_ROOT}/Modules/FindCUDA.cmake)

        # wget http://developer.download.nvidia.com/compute/cuda/4_2/rel/toolkit/cudatoolkit_4.2.9_linux_64_ubuntu11.04.run
        # MYCUDASDK=cudatoolkit_4.2.9_linux_64_ubuntu11.04
        # bash $MYCUDASDK.run --nox11 --noexec --target $MYCUDASDK
        # GZIP=--best tar czf $MYCUDASDK.tar.gz $MYCUDASDK
        ExternalProject_add(${proj_name}
            PREFIX ${ION_TS_EXTERNAL}/${proj_name_version}
            URL "http://${ION_UPDATE_SERVER}/updates/software/external/${cuda_tar_file}"
#            URL_MD5 ""
            TIMEOUT "3600"
            CONFIGURE_COMMAND ""
            BUILD_COMMAND ""
            INSTALL_COMMAND ""
        )

        install(DIRECTORY ${ION_TS_EXTERNAL}/${proj_name_version}/src/cudatoolkit/lib DESTINATION /usr/local/cuda
        	PATTERN .svn EXCLUDE)
        install(DIRECTORY ${ION_TS_EXTERNAL}/${proj_name_version}/src/cudatoolkit/lib64 DESTINATION /usr/local/cuda
        	PATTERN .svn EXCLUDE)
        install(PROGRAMS ${ION_TS_EXTERNAL}/${proj_name_version}/src/cudatoolkit/bin/nvcc DESTINATION /usr/local/cuda/bin)

    else()
        find_package(CUDA REQUIRED)
    endif()
    include_directories(${CUDA_INCLUDE_DIRS})
    message(STATUS "CUDA_LIBRARIES: ${CUDA_LIBRARIES}")
    message(STATUS "CUDA_INCLUDE_DIRS: ${CUDA_INCLUDE_DIRS}")
endif()

if (NOT ION_USE_SYSTEM_FFTW)
  set(proj_name "fftw")
  set(proj_version "3.3")
  set(proj_name_version "${proj_name}-${proj_version}")
  ExternalProject_add(${proj_name}
    PREFIX ${ION_TS_EXTERNAL}/${proj_name_version}
    URL "http://${ION_UPDATE_SERVER}/updates/software/external/fftw-3.3.tar.gz"
#    URL_MD5 "0728ab3ec0ebb06631ab3b80a5c3d130"
    CONFIGURE_COMMAND ${ION_TS_EXTERNAL}/${proj_name_version}/src/${proj_name}/configure
    --enable-static --with-pic
    --prefix=${ION_TS_EXTERNAL}/${proj_name_version}
  )
  include_directories("${ION_TS_EXTERNAL}/${proj_name_version}/include")
  set(ION_FFTW_LIBS "${ION_TS_EXTERNAL}/${proj_name_version}/lib/libfftw3.a")
else()
  set(ION_FFTW_LIBS libfftw3.a)
endif()

if(NOT ION_USE_SYSTEM_HDF5)
  set(proj_name "hdf5")
  set(proj_version "1.8.8")
  set(proj_name_version "${proj_name}-${proj_version}")
  ExternalProject_add(${proj_name}
    PREFIX ${ION_TS_EXTERNAL}/${proj_name_version}
    URL "http://${ION_UPDATE_SERVER}/updates/software/external/hdf5-1.8.8.tar.gz"
#    URL_MD5 1196e668f5592bfb50d1de162eb16cff
    CONFIGURE_COMMAND ${ION_TS_EXTERNAL}/${proj_name_version}/src/${proj_name}/configure
    --with-pic=yes --disable-shared --with-pthread --enable-threadsafe
    --prefix=${ION_TS_EXTERNAL}/${proj_name_version}
  )
  include_directories("${ION_TS_EXTERNAL}/${proj_name_version}/include")
  set(ION_HDF5_LIBS "${ION_TS_EXTERNAL}/${proj_name_version}/lib/libhdf5.a")
else()
  set(HDF5_USE_STATIC_LIBRARIES True)
  find_package(HDF5 REQUIRED)
  set(ION_HDF5_LIBS ${HDF5_LIBRARIES})
endif()

if(NOT ION_USE_SYSTEM_ARMADILLO)
  set(proj_name "armadillo")
  set(proj_version "3.0.2")
  set(proj_name_version "${proj_name}-${proj_version}")
  ExternalProject_add(${proj_name}_proj
    PREFIX ${ION_TS_EXTERNAL}/${proj_name_version}
    URL "http://${ION_UPDATE_SERVER}/updates/software/external/armadillo-3.0.2.tar.gz"
    #URL_MD5 e8400bc7adb65fa0edc8c8ccb49b60eb
    CMAKE_ARGS -DCMAKE_INSTALL_PREFIX:PATH=${ION_TS_EXTERNAL}/${proj_name_version}
    PATCH_COMMAND patch -p1 -t -N < "${PROJECT_SOURCE_DIR}/../external/armadillo-2.4.0.patch"
  )
  set(ION_ARMADILLO_LIBS "${ION_TS_EXTERNAL}/${proj_name_version}/lib/libarmadillo.so")
  include_directories("${ION_TS_EXTERNAL}/${proj_name_version}/include")
else()
  set(ION_ARMADILLO_LIBS "armadillo")
#include_directories("/home/csugnet/local/src/armadillo-3.0.2/include")
#set(ION_ARMADILLO_LIBS "/home/csugnet/local/src/armadillo-3.0.2/libarmadillo.so")
endif()

set(LIBKMEANSFILE "${PROJECT_SOURCE_DIR}/../external/kmeans-1.7/libkmeans.so")
add_custom_command(OUTPUT ${LIBKMEANSFILE}
    COMMAND "make"
    WORKING_DIRECTORY "${PROJECT_SOURCE_DIR}/../external/kmeans-1.7")
add_library(LIBKMEANS STATIC IMPORTED)
set_property(TARGET LIBKMEANS PROPERTY IMPORTED_LOCATION ${LIBKMEANSFILE})
include_directories("${PROJECT_SOURCE_DIR}/../external/kmeans-1.7")

if(NOT ION_USE_SYSTEM_BOOST)
  set(proj_name "boost")
  set(proj_version "1.49.0")
  set(proj_name_version "${proj_name}-${proj_version}")
  ExternalProject_add(${proj_name}
    PREFIX ${ION_TS_EXTERNAL}/${proj_name_version}
    SOURCE_DIR "${ION_TS_EXTERNAL}/${proj_name_version}/src"
    SVN_REPOSITORY "http://svn.boost.org/svn/boost/tags/release/Boost_1_49_0"
    UPDATE_COMMAND ""
    CONFIGURE_COMMAND ./bootstrap.sh
    BUILD_IN_SOURCE 1
    BUILD_COMMAND     ./bjam install
    --build-dir=${ION_TS_EXTERNAL}/${proj_name_version}/boost-build
    --prefix=${ION_TS_EXTERNAL}/${proj_name_version}
    --with-serialization
    INSTALL_COMMAND ""
    )
  include_directories("${ION_TS_EXTERNAL}/${proj_name_version}/include")
  set(ION_BOOST_LIBS "${ION_TS_EXTERNAL}/${proj_name_version}/lib/libboost_serialization.a")
else()
  set(ION_BOOST_LIBS "boost_serialization.a")
endif()

if(NOT ION_USE_SYSTEM_UNWIND)
  set(proj_name "unwind")
  set(proj_version "1.0.1")
  set(proj_name_version "${proj_name}-${proj_version}")
  ExternalProject_add(${proj_name}
    PREFIX ${ION_TS_EXTERNAL}/${proj_name_version}
    URL "http://${ION_UPDATE_SERVER}/updates/software/external/libunwind-1.0.1.tar.gz"
    CONFIGURE_COMMAND ${ION_TS_EXTERNAL}/${proj_name_version}/src/${proj_name}/configure
    CFLAGS=-D_FORTIFY_SOURCE=0
    --with-pic=yes --disable-shared
    --prefix=${ION_TS_EXTERNAL}/${proj_name_version}
  )
  include_directories("${ION_TS_EXTERNAL}/${proj_name_version}/include")
  set(ION_UNWIND_LIBS "${ION_TS_EXTERNAL}/${proj_name_version}/lib/libunwind.a")
else()
  set(UNWIND_USE_STATIC_LIBRARIES True)
  find_package(UNWIND REQUIRED)
  set(ION_UNWIND_LIBS ${UNWIND_LIBRARIES})
endif()

# uncomment for profiling if gprofile and unwind installed
# add_library(UNWIND STATIC IMPORTED)
# set_property(TARGET UNWIND PROPERTY IMPORTED_LOCATION "/usr/local/lib/libunwind.a")
# add_library(PROFILE STATIC IMPORTED)
# set_property(TARGET PROFILE PROPERTY IMPORTED_LOCATION "/usr/local/lib/libprofiler.a")

include_directories("${PROJECT_BINARY_DIR}")
include_directories("${PROJECT_SOURCE_DIR}")
include_directories("${PROJECT_SOURCE_DIR}/../buildTools")
include_directories("${PROJECT_SOURCE_DIR}/../external/tnt-1.2.6")
include_directories("${PROJECT_SOURCE_DIR}/../external/fstrcmp")
include_directories("${PROJECT_SOURCE_DIR}/../external/jsoncpp-src-amalgated0.6.0-rc1")


if (NOT ION_USE_SYSTEM_SAMTOOLS)
  set(proj_name "samtools")
  set(proj_version "0.1.18")
  set(proj_name_version "${proj_name}-${proj_version}")
  ExternalProject_add(${proj_name}
    PREFIX ${ION_TS_EXTERNAL}/${proj_name_version}-prefix
    URL "http://${ION_UPDATE_SERVER}/updates/software/external/samtools-0.1.18.tar.gz"
    #URL_MD5 7373854ca343ebee6a52874fcfc3a4a4
    # in source build
    BINARY_DIR "${ION_TS_EXTERNAL}/${proj_name_version}"
    SOURCE_DIR "${ION_TS_EXTERNAL}/${proj_name_version}"
    PATCH_COMMAND patch -p1 -t -N < "${ION_TS_EXTERNAL}/samtools-0.1.18.patch"
    CONFIGURE_COMMAND ""
    BUILD_COMMAND "/usr/bin/make" "CFLAGS=-fPIC" "<SOURCE_DIR>/Makefile" "lib"
    INSTALL_COMMAND ""
    #INSTALL_COMMAND "/usr/bin/make" "CFLAGS=-fPIC" "<SOURCE_DIR>/Makefile" "libbam.so"
  )
  include_directories("${ION_TS_EXTERNAL}/${proj_name_version}")
  #set(ION_SAMTOOLS_LIBS "${ION_TS_EXTERNAL}/${proj_name_version}/libbam.so")
  set(ION_SAMTOOLS_LIBS "${ION_TS_EXTERNAL}/${proj_name_version}/libbam.a")
else()
    set(ION_SAMTOOLS_LIBS libbam.a)
    include_directories("/usr/include/samtools")
endif()

include_directories("${PROJECT_SOURCE_DIR}/Replay")
include_directories("${PROJECT_SOURCE_DIR}/AnalysisOrg")
include_directories("${PROJECT_SOURCE_DIR}/AnalysisOrg/justBeadFind")
include_directories("${PROJECT_SOURCE_DIR}/AnalysisOrg/IO")
include_directories("${PROJECT_SOURCE_DIR}/BkgModel")
include_directories("${PROJECT_SOURCE_DIR}/SynchDat")
include_directories("${PROJECT_SOURCE_DIR}/BkgModel/MathModel")
include_directories("${PROJECT_SOURCE_DIR}/BkgModel/Bookkeeping")
include_directories("${PROJECT_SOURCE_DIR}/BkgModel/LocalTrace")
include_directories("${PROJECT_SOURCE_DIR}/BkgModel/Fitters")
include_directories("${PROJECT_SOURCE_DIR}/BkgModel/Fitters/Complex")
include_directories("${PROJECT_SOURCE_DIR}/BkgModel/Writers")
include_directories("${PROJECT_SOURCE_DIR}/BkgModel/CUDA")
include_directories("${PROJECT_SOURCE_DIR}/BaseCaller")
include_directories("${PROJECT_SOURCE_DIR}/Separator")
include_directories("${PROJECT_SOURCE_DIR}/Util")
#this has enough files now to justify own directory
include_directories("${PROJECT_SOURCE_DIR}/Image")
include_directories("${PROJECT_SOURCE_DIR}/Mask")
include_directories("${PROJECT_SOURCE_DIR}/Wells")


# CUDA Files
if(ION_USE_CUDA)
    SET( CUDA_NVCC_FLAGS "--use_fast_math" "-gencode=arch=compute_20,code=compute_20" "-maxrregcount=48" )
    CUDA_COMPILE(CUDA_TEMP_FILES 
      BkgModel/CUDA/BkgModel.cu
      BkgModel/CUDA/StreamManager.cu 
      BkgModel/CUDA/SingleFitStream.cu
      SHARED
    )
endif()

# Ion Analysis Library
add_library(ion-analysis
    ${LIBKMEANSFILE}

    ${PROJECT_BINARY_DIR}/IonVersion.cpp

    Barcode/BarCode.cpp


    Wells/RawWells.cpp
    Wells/RawWellsV1.cpp

    Image/deInterlace.cpp
    Image/Image.cpp
    Image/TikhonovSmoother.cpp
    Image/PreDefinedTikParams.cpp
    Image/ChipIdDecoder.cpp
    Image/ImageTransformer.cpp
    Image/LSRowImageProcessor.cpp
    Image/ComparatorNoiseCorrector.cpp

    
    Mask/PinnedInFlow.cpp
    Mask/Mask.cpp
    Mask/ComplexMask.cpp
    
    Separator/DualGaussMixModel.cpp
    Separator/Separator.cpp
    Separator/DifferentialSeparator.cpp
    Separator/KeyClassifier.cpp
    Separator/KClass.cpp
    Separator/BFReference.cpp
    Separator/Traces.cpp

    Util/H5File.cpp
    Util/IonErr.cpp
    Util/Utils.cpp
    Util/HandleExpLog.cpp
    Util/OptArgs.cpp
    Util/OptionArgsBase.cpp
    Util/OptionArgs.cpp
    Util/LoggerBase.cpp
    Util/Logger.cpp
    Util/bivariate_gaussian.cpp
    Util/flow_utils.cpp
    Util/WorkerInfoQueue.cpp
    Util/StackUnwind.cpp

    AnalysisOrg/IO/CommandLineOpts.cpp
    AnalysisOrg/IO/KeyContext.cpp
    AnalysisOrg/IO/FlowContext.cpp
    AnalysisOrg/IO/BkgControlOpts.cpp
    AnalysisOrg/IO/BeadfindControlOpts.cpp
    AnalysisOrg/IO/ImageControlOpts.cpp
    AnalysisOrg/IO/BkgModelHdf5.cpp
    AnalysisOrg/IO/TrackProgress.cpp
    AnalysisOrg/IO/ProgramState.cpp
    AnalysisOrg/IO/CaptureImageState.cpp
    
    AnalysisOrg/justBeadFind/SeparatorInterface.cpp
    AnalysisOrg/justBeadFind/SetUpForProcessing.cpp
    
    AnalysisOrg/SystemContext.cpp
    AnalysisOrg/SpatialContext.cpp
    AnalysisOrg/ImageSpecClass.cpp
    AnalysisOrg/ImageLoader.cpp
    AnalysisOrg/ImageLoaderQueue.cpp
    AnalysisOrg/ProcessImageToWell.cpp
    AnalysisOrg/RegionTimingCalc.cpp
    AnalysisOrg/SeqList.cpp
    AnalysisOrg/WellFileManipulation.cpp
    AnalysisOrg/GlobalDefaultsFromBkgControl.cpp
    AnalysisOrg/BkgDataPointers.cpp
    AnalysisOrg/BkgFitterTracker.cpp
    AnalysisOrg/SlicedPrequel.cpp
    AnalysisOrg/SignalProcessingFitterQueue.cpp
    AnalysisOrg/ClonalFilter.cpp
    AnalysisOrg/MaskFunctions.cpp
    AnalysisOrg/cudaWrapper.cpp
        
    Region.cpp
    LinuxCompat.cpp
    Stats.cpp

    LevMarFitterV2.cpp
    
    mixed.cpp
    # T0CalcMt.cpp

    Histogram.cpp
    
    BaseCaller/DPTreephaser.cpp
    
    BkgModel/MathModel/MathOptim.cpp
    BkgModel/MathModel/DualNumber.cpp
    BkgModel/MathModel/PoissonCdf.cpp
    BkgModel/MathModel/DNTPRiseModel.cpp
    BkgModel/MathModel/DiffEqModel.cpp
    BkgModel/MathModel/DiffEqModelVec.cpp
    BkgModel/MathModel/Hydrogen.cpp
    BkgModel/MathModel/FastTrace.cpp
    BkgModel/MathModel/MathUtil.cpp
    BkgModel/MathModel/MiscVec.cpp
    BkgModel/MathModel/MultiFlowModel.cpp

    BkgModel/Bookkeeping/BeadParams.cpp
    BkgModel/Bookkeeping/BeadTracker.cpp
    BkgModel/Bookkeeping/RegionParams.cpp
    BkgModel/Bookkeeping/RegionTracker.cpp
    BkgModel/Bookkeeping/FlowBuffer.cpp
    BkgModel/Bookkeeping/NucStepCache.cpp
    BkgModel/Bookkeeping/TimeCompression.cpp
    BkgModel/Bookkeeping/EmphasisVector.cpp
    BkgModel/Bookkeeping/DarkHalo.cpp
    BkgModel/Bookkeeping/CrossTalkSpec.cpp
    BkgModel/Bookkeeping/XtalkCurry.cpp
    BkgModel/Bookkeeping/TraceCurry.cpp
    BkgModel/Bookkeeping/BeadScratch.cpp

    BkgModel/LocalTrace/BkgTrace.cpp
    BkgModel/LocalTrace/EmptyTrace.cpp
    BkgModel/LocalTrace/TraceClassifier.cpp
    BkgModel/LocalTrace/EmptyTraceTracker.cpp
    #BkgModel/LocalTrace/FindReference.cpp

    BkgModel/Fitters/Complex/FitControl.cpp
    BkgModel/Fitters/Complex/MultiLevMar.cpp
    BkgModel/Fitters/Complex/LevMarState.cpp
    BkgModel/Fitters/Complex/BkgFitMatrixPacker.cpp
    BkgModel/Fitters/Complex/BkgFitStructures.cpp
    BkgModel/Fitters/Complex/BkgFitOptim.cpp
    
    BkgModel/Fitters/SingleFlowFit.cpp
    BkgModel/Fitters/RefineFit.cpp
    BkgModel/Fitters/RefineTime.cpp
    BkgModel/Fitters/SpatialCorrelator.cpp
    BkgModel/Fitters/BkgSearchAmplitude.cpp
    BkgModel/Fitters/DarkMatter.cpp
    BkgModel/Fitters/TraceCorrector.cpp

    BkgModel/Writers/DebugWriter.cpp
    BkgModel/Writers/GlobalWriter.cpp
    
    BkgModel/GlobalDefaultsForBkgModel.cpp
    BkgModel/SignalProcessingMasterFitter.cpp
    BkgModel/RegionalizedData.cpp

    BkgModel/CUDA/JobWrapper.cpp 

    SynchDat/BitHandler.cpp
    SynchDat/HuffmanEncode.cpp
    SynchDat/SynchDatSerialize.cpp
    SynchDat/VencoLossless.cpp
    SynchDat/SvdDatCompress.cpp
    SynchDat/DelicatoCompression.cpp
    SynchDat/compression.cpp
    SynchDat/matrixRounding.cpp
    SynchDat/unpackMatrix.cpp
    SynchDat/packMatrix.cpp
    SynchDat/SvdDatCompressPlus.cpp

    Replay/FileBkgReplay.cpp
    Replay/H5Replay.cpp
    Replay/PinnedInFlowReplay.cpp
    Replay/EmptyTraceReplay.cpp
    Replay/RegionTrackerReplay.cpp
    Replay/BkgModelReplay.cpp

    crop/Acq.cpp
    
    FileEquivalent.cpp
    
    ${PROJECT_SOURCE_DIR}/../external/fstrcmp/fstrcmp.cpp
    
    SFFWrapper.cpp
    
    SamUtils/types/Cigar.cpp
    SamUtils/types/Qual.cpp
    SamUtils/types/Sequence.cpp
    SamUtils/types/BAMRead.cpp
    SamUtils/types/MD.cpp
    SamUtils/BAMReader.cpp
    SamUtils/BAMUtils.cpp
    SamUtils/alignStats.cpp

    ${PROJECT_SOURCE_DIR}/../external/jsoncpp-src-amalgated0.6.0-rc1/jsoncpp.cpp
    ${CUDA_TEMP_FILES}
)

if(ICC)
# compiling fftw separately with icc, should figure it out here...
# in the fftw-3.2.2 directory
# ./configure CC=icc CFLAGS=-gcc --with-our-malloc16 --enable-threads --with-combined-threads -enable-sse2
add_dependencies(ion-analysis IONVERSION samtools armadillo_proj hdf5 boost unwind)
else()
add_dependencies(ion-analysis IONVERSION samtools fftw armadillo_proj hdf5 boost unwind)
endif()
if(ION_USE_CUDA)
  if(NOT ION_USE_SYSTEM_CUDA)
    add_dependencies(ion-analysis cudatoolkit)
    # Changes J30
    #add_dependencies(ion-analysis cudatoolkit armadillo_proj)
  endif()
endif()

if(ICC)
  # something fftw? depends on MKL_LIBRARIES and shouldn't
  target_link_libraries(ion-analysis ${ION_FFTW_LIBS} ${ION_HDF5_LIBS} LIBKMEANS ${ION_BOOST_LIBS} ${ION_ARMADILLO_LIBS} ${ION_UNWIND_LIBS} ${MKL_LIBRARIES} file-io z)
else()
  target_link_libraries(ion-analysis ${ION_FFTW_LIBS} ${ION_HDF5_LIBS} LIBKMEANS ${ION_BOOST_LIBS} ${ION_ARMADILLO_LIBS} ${ION_UNWIND_LIBS} blas lapack lapack_atlas atlas file-io z)
endif()
#target_link_libraries(ion-analysis ${ION_FFTW_LIBS} ${ION_HDF5_LIBS} LIBKMEANS ${ION_ARMADILLO_LIBS} blas lapack lapack_atlas atlas file-io z)


set_target_properties(ion-analysis PROPERTIES
    VERSION   "${ION_VERSION_MAJOR}.${ION_VERSION_MINOR}.${ION_VERSION_RELEASE}.${ION_VERSION_BUILDNUM}"
)
if( CMAKE_SYSTEM_PROCESSOR STREQUAL "x86_64" )
        set_target_properties(ion-analysis PROPERTIES COMPILE_FLAGS "-fPIC")
endif( CMAKE_SYSTEM_PROCESSOR STREQUAL "x86_64" )
install(TARGETS ion-analysis DESTINATION lib)


add_executable( SFFExtract SFFExtract.cpp ../buildTools/dbgmem.cpp ${PROJECT_BINARY_DIR}/IonVersion.cpp)
add_dependencies( SFFExtract IONVERSION)
target_link_libraries( SFFExtract ion-analysis pthread)

add_executable( SFFExtract_sam SFFExtract_sam.cpp ../buildTools/dbgmem.cpp ${PROJECT_BINARY_DIR}/IonVersion.cpp)
add_dependencies( SFFExtract_sam IONVERSION)
target_link_libraries( SFFExtract_sam ion-analysis pthread)

add_executable(Crop crop/Crop.cpp ../buildTools/dbgmem.cpp ${PROJECT_BINARY_DIR}/IonVersion.cpp)
add_dependencies(Crop IONVERSION)
target_link_libraries(Crop ion-analysis pthread)
install(TARGETS Crop DESTINATION bin)

add_executable(ChkDat crop/ChkDat.cpp ../buildTools/dbgmem.cpp ${PROJECT_BINARY_DIR}/IonVersion.cpp)
add_dependencies(ChkDat IONVERSION)
target_link_libraries(ChkDat ion-analysis pthread)
install(TARGETS ChkDat DESTINATION bin)

add_executable(Blocks crop/Blocks.cpp ../buildTools/dbgmem.cpp ${PROJECT_BINARY_DIR}/IonVersion.cpp)
add_dependencies(Blocks IONVERSION)
target_link_libraries(Blocks ion-analysis pthread)
install(TARGETS Blocks DESTINATION bin)

add_executable(MergeImages crop/MergeImages.cpp crop/MergeAcq.cpp ../buildTools/dbgmem.cpp ${PROJECT_BINARY_DIR}/IonVersion.cpp)
add_dependencies(MergeImages IONVERSION)
target_link_libraries(MergeImages ion-analysis pthread)
install(TARGETS MergeImages DESTINATION bin)

add_executable(MergeDats crop/MergeDats.cpp crop/MergeAcq.cpp ../buildTools/dbgmem.cpp ${PROJECT_BINARY_DIR}/IonVersion.cpp)
add_dependencies(MergeDats IONVERSION)
target_link_libraries(MergeDats ion-analysis pthread)
install(TARGETS MergeDats DESTINATION bin)

add_executable(Archive crop/Archive.cpp ../buildTools/dbgmem.cpp ${PROJECT_BINARY_DIR}/IonVersion.cpp)
add_dependencies(Archive IONVERSION)
target_link_libraries(Archive ion-analysis pthread)

if(ION_DO_BACKGROUND)
    add_executable(Analysis AnalysisOrg/Analysis.cpp ../buildTools/dbgmem.cpp ${PROJECT_BINARY_DIR}/IonVersion.cpp)
    add_dependencies(Analysis IONVERSION)

    if (USE_MKL AND ION_USE_CUDA)
        target_link_libraries(Analysis ion-analysis pthread ${CUDA_LIBRARIES}) 
    endif()

    if (NOT USE_MKL AND ION_USE_CUDA)
        target_link_libraries(Analysis ion-analysis gsl gslcblas pthread lapack_atlas atlas  ${CUDA_LIBRARIES})
    endif()

    if (USE_MKL AND NOT ION_USE_CUDA)
        target_link_libraries(Analysis ion-analysis pthread) 
    endif()
    if (NOT USE_MKL AND NOT ION_USE_CUDA)
        target_link_libraries(Analysis ion-analysis gsl gslcblas pthread lapack_atlas atlas)
    endif()

    install(TARGETS Analysis DESTINATION bin)

#    add_executable(bkgFit bkgFit.cpp ../buildTools/dbgmem.cpp ${PROJECT_BINARY_DIR}/IonVersion.cpp)
#    add_dependencies(bkgFit IONVERSION)
#    if (ION_USE_CUDA)
#        target_link_libraries(bkgFit ion-analysis pthread ${CUDA_LIBRARIES} ${ION_ARMADILLO_LIBS})
#    else()
#	target_link_libraries(bkgFit ion-analysis ${GTEST_BOTH_LIBRARIES} gsl gslcblas pthread lapack_atlas atlas)
#    endif()
#    if (USE_MKL AND NOT ION_USE_CUDA)
      # probably breaks... not tested
#	target_link_libraries(ion-analysis $GTEST_BOTH_LIBRARIES} pthread)
#    endif()
endif()

## Standalone BeadFind
add_executable(justBeadFind AnalysisOrg/justBeadFind/justBeadFind.cpp ../buildTools/dbgmem.cpp ${PROJECT_BINARY_DIR}/IonVersion.cpp)
add_dependencies(justBeadFind IONVERSION)
target_link_libraries(justBeadFind ion-analysis gsl gslcblas pthread lapack_atlas atlas )
install(TARGETS justBeadFind DESTINATION bin)

## Standalone BaseCaller
add_executable(BaseCaller 
    BaseCaller/BaseCaller.cpp
    BaseCaller/BaseCallerFilters.cpp
    BaseCaller/PerBaseQual.cpp
    BaseCaller/RegionWellsReader.cpp
    BaseCaller/RegionAnalysis.cpp
    BaseCaller/PhaseEstimator.cpp
    BaseCaller/OrderedRegionSFFWriter.cpp
    BaseCaller/BaseCallerMetricSaver.cpp
    BaseCaller/TreephaserSSE.cpp
    BaseCaller/BarcodeClassifier.cpp
    ../buildTools/dbgmem.cpp ${PROJECT_BINARY_DIR}/IonVersion.cpp)
add_dependencies(BaseCaller IONVERSION)
target_link_libraries(BaseCaller ion-analysis gsl gslcblas pthread lapack_atlas atlas)
install(TARGETS BaseCaller DESTINATION bin)

## Standalone BaseCaller - Lite
add_executable(BaseCallerLite
    BaseCaller/BaseCallerLite.cpp 
    BaseCaller/OrderedRegionSFFWriter.cpp
    ${PROJECT_BINARY_DIR}/IonVersion.cpp)
add_dependencies(BaseCallerLite IONVERSION)
target_link_libraries(BaseCallerLite ion-analysis gsl gslcblas pthread lapack_atlas atlas)


add_executable(TFMapper TestFragments/TFMapper.cpp ../buildTools/dbgmem.cpp ${PROJECT_BINARY_DIR}/IonVersion.cpp)
add_dependencies(TFMapper IONVERSION)
target_link_libraries(TFMapper ion-analysis ${ION_SAMTOOLS_LIBS} pthread)
install(TARGETS TFMapper DESTINATION bin)


add_executable(PairedEndErrorCorrection
   ${PROJECT_BINARY_DIR}/IonVersion.cpp
   SFFCorrection/Alignment.cpp
   SFFCorrection/Cell.cpp
   SFFCorrection/semaphore.cpp
   SFFCorrection/Sequence.cpp
   SFFCorrection/sffCorrection.cpp
   SFFCorrection/SmithWaterman.cpp)
add_dependencies(PairedEndErrorCorrection IONVERSION)
target_link_libraries(PairedEndErrorCorrection file-io pthread)
install(TARGETS PairedEndErrorCorrection DESTINATION bin)

# add_executable(WellsTimer WellsTimer.cpp ../buildTools/dbgmem.cpp ${PROJECT_BINARY_DIR}/IonVersion.cpp)
# add_dependencies(WellsTimer IONVERSION)
# target_link_libraries(WellsTimer ion-analysis pthread)
# install(TARGETS WellsTimer DESTINATION bin)


add_executable(MeasureXTalk MeasureXTalk.cpp ../buildTools/dbgmem.cpp ${PROJECT_BINARY_DIR}/IonVersion.cpp)
add_dependencies(MeasureXTalk IONVERSION)
target_link_libraries(MeasureXTalk ion-analysis pthread)

add_executable(WellCrossTalk WellCrossTalk.cpp ../buildTools/dbgmem.cpp ${PROJECT_BINARY_DIR}/IonVersion.cpp)
add_dependencies(WellCrossTalk IONVERSION)
target_link_libraries(WellCrossTalk ion-analysis pthread ${ION_ARMADILLO_LIBS})

add_executable(Recall
	Recall/Recall.cpp
	../buildTools/dbgmem.cpp
	${PROJECT_BINARY_DIR}/IonVersion.cpp)
target_link_libraries(Recall ion-analysis file-io)
install(TARGETS Recall DESTINATION bin)

add_executable(SeqBoost
        Recall/SeqBoost.cpp
        ../buildTools/dbgmem.cpp
        ${PROJECT_BINARY_DIR}/IonVersion.cpp)
target_link_libraries(SeqBoost ion-analysis file-io)
install(TARGETS SeqBoost DESTINATION bin)

add_executable(SamVsSam
        SamUtils/SamVsSam.cpp
)
target_link_libraries(SamVsSam ion-analysis ${ION_SAMTOOLS_LIBS})
install(TARGETS SamVsSam DESTINATION bin)

add_executable(SFFSummary
        SFFSummary/SFFSummary.cpp
        SFFSummary/SFFSummaryDriver.cpp
        ${PROJECT_BINARY_DIR}/IonVersion.cpp
)
target_link_libraries(SFFSummary ion-analysis file-io pthread)
add_dependencies(SFFSummary IONVERSION)
install(TARGETS SFFSummary DESTINATION bin)

add_executable(BeadmaskParse BeadmaskParse.cpp ../buildTools/dbgmem.cpp ${PROJECT_BINARY_DIR}/IonVersion.cpp)
add_dependencies(BeadmaskParse IONVERSION)
target_link_libraries(BeadmaskParse ion-analysis pthread)
install(TARGETS BeadmaskParse DESTINATION bin)

add_executable(BeadmaskMerge BeadmaskMerge.cpp ../buildTools/dbgmem.cpp ${PROJECT_BINARY_DIR}/IonVersion.cpp)
add_dependencies(BeadmaskMerge IONVERSION)
target_link_libraries(BeadmaskMerge ion-analysis pthread)
install(TARGETS BeadmaskMerge DESTINATION bin)

add_executable(MergeWells Wells/MergeWells.cpp ../buildTools/dbgmem.cpp ${PROJECT_BINARY_DIR}/IonVersion.cpp)
add_dependencies(MergeWells IONVERSION)
target_link_libraries(MergeWells ion-analysis pthread)
install(TARGETS MergeWells DESTINATION bin)

include_directories("${PROJECT_SOURCE_DIR}/file-io")
add_library(file-io
        file-io/dat_chip.c
        file-io/dat_flow.c
        file-io/dat_frame.c
        file-io/dat_header.c
        file-io/dat_io.c
        file-io/fastq.c
        file-io/fastq_file.c
        file-io/ion_alloc.c
        file-io/ion_error.c
        file-io/ion_string.c
        file-io/ion_util.c
        file-io/sff.c
        file-io/sff_file.c
        file-io/sff_header.c
        file-io/sff_index.c
        file-io/sff_iter.c
        file-io/sff_read.c
        file-io/sff_read_header.c
        file-io/sff_sort.c
        file-io/wells_chip.c
        file-io/wells_data.c
        file-io/wells_header.c
        file-io/wells_mask.c
)
if( CMAKE_SYSTEM_PROCESSOR STREQUAL "x86_64" )
        set_target_properties(file-io PROPERTIES COMPILE_FLAGS "-fPIC")
endif( CMAKE_SYSTEM_PROCESSOR STREQUAL "x86_64" )

add_executable(SFFTrim
        SFFTrim/SFFTrim.cpp
        ${PROJECT_BINARY_DIR}/IonVersion.cpp
)
target_link_libraries(SFFTrim ion-analysis file-io pthread)
add_dependencies(SFFTrim IONVERSION)
install(TARGETS SFFTrim DESTINATION bin)

add_executable(SFFSearch
        SFFTrim/SFFSearch.cpp
        ${PROJECT_BINARY_DIR}/IonVersion.cpp
)
target_link_libraries(SFFSearch ion-analysis file-io pthread)
add_dependencies(SFFSearch IONVERSION)

add_executable(alignStats
        SamUtils/alignStats_driver.cpp
        ${PROJECT_BINARY_DIR}/IonVersion.cpp
)
target_link_libraries(alignStats ion-analysis z ${ION_SAMTOOLS_LIBS} pthread)
add_dependencies(alignStats IONVERSION)
install(TARGETS alignStats DESTINATION bin)

add_executable(SFFRead SFFUtils/SFFRead.cpp ../buildTools/dbgmem.cpp ${PROJECT_BINARY_DIR}/IonVersion.cpp)
add_dependencies(SFFRead IONVERSION)
target_link_libraries(SFFRead ion-analysis pthread)
install(TARGETS SFFRead DESTINATION bin)

add_executable(SFFMerge SFFMerge.cpp ${PROJECT_BINARY_DIR}/IonVersion.cpp)
add_dependencies(SFFMerge IONVERSION)
target_link_libraries(SFFMerge ion-analysis)
install(TARGETS SFFMerge DESTINATION bin)

add_executable(SFFRandom SFFUtils/SFFRandom.cpp ../buildTools/dbgmem.cpp ${PROJECT_BINARY_DIR}/IonVersion.cpp)
add_dependencies(SFFRandom IONVERSION)
target_link_libraries(SFFRandom ion-analysis pthread)
install(TARGETS SFFRandom DESTINATION bin)

add_executable(RawWellsEquivalent Wells/RawWellsEquivalent.cpp ../buildTools/dbgmem.cpp ${PROJECT_BINARY_DIR}/IonVersion.cpp)
add_dependencies(RawWellsEquivalent IONVERSION)
target_link_libraries(RawWellsEquivalent ion-analysis pthread)
install(TARGETS RawWellsEquivalent DESTINATION bin)

add_executable(DiffSeparator Separator/DiffSeparator.cpp ../buildTools/dbgmem.cpp ${PROJECT_BINARY_DIR}/IonVersion.cpp)
add_dependencies(DiffSeparator IONVERSION)
target_link_libraries(DiffSeparator ion-analysis pthread ${ION_ARMADILLO_LIBS})
install(TARGETS DiffSeparator DESTINATION bin)


add_executable(TraceDriver SynchDat/TraceDriver.cpp ../buildTools/dbgmem.cpp ${PROJECT_BINARY_DIR}/IonVersion.cpp)
add_dependencies(TraceDriver IONVERSION)
target_link_libraries(TraceDriver ion-analysis pthread )

# add_executable(ImageT0 ImageT0.cpp ../buildTools/dbgmem.cpp ${PROJECT_BINARY_DIR}/IonVersion.cpp)
# add_dependencies(ImageT0 IONVERSION)
# target_link_libraries(ImageT0 ion-analysis  -lunwind pthread -lprofiler )
# install(TARGETS ImageT0 DESTINATION bin)

#add_executable(PinnedWell PinnedWell.cpp ../buildTools/dbgmem.cpp ${PROJECT_BINARY_DIR}/IonVersion.cpp)
#add_dependencies(PinnedWell IONVERSION)
#target_link_libraries(PinnedWell ion-analysis  pthread )
#install(TARGETS PinnedWell DESTINATION bin)

add_executable(readDat readDat.cpp ${PROJECT_BINARY_DIR}/IonVersion.cpp)
add_dependencies(readDat IONVERSION)
#target_link_libraries(readDat ion-analysis pthread)
target_link_libraries(readDat ion-analysis ${GTEST_BOTH_LIBRARIES} gsl gslcblas pthread lapack_atlas atlas)
install(TARGETS readDat DESTINATION bin)

add_executable(readWells Wells/readWells.cpp ${PROJECT_BINARY_DIR}/IonVersion.cpp)
add_dependencies(readWells IONVERSION)
target_link_libraries(readWells ion-analysis pthread)
install(TARGETS readWells DESTINATION bin)

add_executable(SFFEquivalent SFFEquivalent.cpp ../buildTools/dbgmem.cpp ${PROJECT_BINARY_DIR}/IonVersion.cpp)
add_dependencies(SFFEquivalent IONVERSION)
target_link_libraries(SFFEquivalent ion-analysis pthread)
install(TARGETS SFFEquivalent DESTINATION bin)

add_executable(iontools file-io/main.c file-io/sff_check.c ../buildTools/dbgmem.cpp ${PROJECT_BINARY_DIR}/IonVersion.cpp)
add_dependencies(iontools IONVERSION)
target_link_libraries(iontools ion-analysis file-io pthread)
install(TARGETS iontools DESTINATION bin)

add_executable(barcodeSplit Barcode/barcodeSplit.cpp ${PROJECT_BINARY_DIR}/IonVersion.cpp)
add_dependencies(barcodeSplit IONVERSION)
target_link_libraries(barcodeSplit ion-analysis)
install(TARGETS barcodeSplit DESTINATION bin)

add_executable(barcodeMaskParse Barcode/barcodeMaskParse.cpp ${PROJECT_BINARY_DIR}/IonVersion.cpp)
add_dependencies(barcodeMaskParse IONVERSION)
target_link_libraries(barcodeMaskParse ion-analysis)
install(TARGETS barcodeMaskParse DESTINATION bin)


add_executable(SFFUtils
  SFFUtils/SFFUtils.cpp
  SFFUtils/SFFUtilsSummary.cpp
  SFFSummary/SFFSummary.cpp
  SFFUtils/SFFUtilsRead.cpp
  ../buildTools/dbgmem.cpp
  ${PROJECT_BINARY_DIR}/IonVersion.cpp)
add_dependencies(SFFUtils IONVERSION)
target_link_libraries(SFFUtils ion-analysis file-io pthread)
install(TARGETS SFFUtils DESTINATION bin)



# Setup for testing and gtest in particular, only needed once in file before tests.
enable_testing()
find_package(GTest QUIET)
if(GTEST_FOUND)
  
# Copy over test data...
   configure_file (
     "utest/reference.txt"
     "${CMAKE_CURRENT_BINARY_DIR}/reference.txt"
     COPYONLY
    )
   configure_file (
     "utest/traces.txt"
     "${CMAKE_CURRENT_BINARY_DIR}/traces.txt"
      COPYONLY
   )
   # configure_file (
   #   "utest/1.wells"
   #   "${CMAKE_CURRENT_BINARY_DIR}/1.wells"
   # )
   configure_file (
     "utest/reference.txt"
     "${CMAKE_CURRENT_BINARY_DIR}/reference.txt"
     COPYONLY
   )
   configure_file (
     "utest/trimdata/sim.flow-TACG.adapter-ATCACCGACTGCCCATAGAGAGGCTGAGACTGCCAAGGCACACAGGGGATAGG.txt"
     "${CMAKE_CURRENT_BINARY_DIR}/sim.flow-TACG.adapter-ATCACCGACTGCCCATAGAGAGGCTGAGACTGCCAAGGCACACAGGGGATAGG.txt"
     COPYONLY
    )

    configure_file (
     "utest/trimdata/sim.flow-TACG.adapter-CTGAGACTGCCAAGGCACACAGGGGATAGG.txt"
     "${CMAKE_CURRENT_BINARY_DIR}/sim.flow-TACG.adapter-CTGAGACTGCCAAGGCACACAGGGGATAGG.txt"
      COPYONLY
     )
    configure_file (
     "utest/trimdata/sim.flow-TACGTACGTCTGAGCATCGATCGATGTACAGC.adapter-ATCACCGACTGCCCATAGAGAGGCTGAGACTGCCAAGGCACACAGGGGATAGG.txt"
     "${CMAKE_CURRENT_BINARY_DIR}/sim.flow-TACGTACGTCTGAGCATCGATCGATGTACAGC.adapter-ATCACCGACTGCCCATAGAGAGGCTGAGACTGCCAAGGCACACAGGGGATAGG.txt"
      COPYONLY
     )
    configure_file (
     "utest/trimdata/sim.flow-TACGTACGTCTGAGCATCGATCGATGTACAGC.adapter-CTGAGACTGCCAAGGCACACAGGGGATAGG.txt"
     "${CMAKE_CURRENT_BINARY_DIR}/sim.flow-TACGTACGTCTGAGCATCGATCGATGTACAGC.adapter-CTGAGACTGCCAAGGCACACAGGGGATAGG.txt"
      COPYONLY
     )


        include_directories(${GTEST_INCLUDE_DIRS})
        add_executable(AnalysisIntegrationTest itest/AnalysisIntegrationTest.cpp)
        target_link_libraries(AnalysisIntegrationTest ion-analysis ${GTEST_BOTH_LIBRARIES} pthread)
  # For each test file

        add_executable(IonErr_Test utest/IonErr_Test.cpp)
        target_link_libraries(IonErr_Test ion-analysis ${GTEST_BOTH_LIBRARIES})
        add_test(IonErrTest IonErr_Test --gtest_output=xml:./)

        add_executable(Mask_Test utest/Mask_Test.cpp)
        target_link_libraries(Mask_Test ion-analysis ${GTEST_BOTH_LIBRARIES})
        add_test(MaskTest Mask_Test --gtest_output=xml:./)

        # add_executable(Wells_Test utest/Wells_Test.cpp)
        # target_link_libraries(Wells_Test ion-analysis ${ION_HDF5_LIBS} ${GTEST_BOTH_LIBRARIES} pthread z)
        # add_test(WellsTest Wells_Test --gtest_output=xml:./)

        add_executable(DualGaussMixModel_Test utest/DualGaussMixModel_Test.cpp)
        target_link_libraries(DualGaussMixModel_Test ion-analysis ${GTEST_BOTH_LIBRARIES})
        add_test(DualGaussMixModelTest DualGaussMixModel_Test --gtest_output=xml:./)

        # add_executable(ZeromerDiff_Test utest/ZeromerDiff_Test.cpp)
        # target_link_libraries(ZeromerDiff_Test ion-analysis ${GTEST_BOTH_LIBRARIES}  )
        # add_test(ZeromerDiffTest ZeromerDiff_Test --gtest_output=xml:./)

        add_executable(FindSlopeChange_Test utest/FindSlopeChange_Test.cpp)
        target_link_libraries(FindSlopeChange_Test ion-analysis ${GTEST_BOTH_LIBRARIES} blas lapack_atlas atlas )
#        add_test(FindSlopeChangeTest FindSlopeChange_Test --gtest_output=xml:./)

        add_executable(T0Model_Test utest/T0Model_Test.cpp)
        target_link_libraries(T0Model_Test ion-analysis ${GTEST_BOTH_LIBRARIES} blas lapack_atlas atlas)
        add_test(T0ModelTest T0Model_Test --gtest_output=xml:./)

        # add_executable(KeyClassifier_Test utest/KeyClassifier_Test.cpp)
        # target_link_libraries(KeyClassifier_Test ion-analysis ${GTEST_BOTH_LIBRARIES}  )
        # add_test(KeyClassifierTest KeyClassifier_Test --gtest_output=xml:./)

        add_executable(NumericalComparison_Test utest/NumericalComparison_Test.cpp)
        target_link_libraries(NumericalComparison_Test ion-analysis ${GTEST_BOTH_LIBRARIES})
        add_test(NumericalComparisonTest NumericalComparison_Test --gtest_output=xml:./)

        add_executable(OptArgs_Test utest/OptArgs_Test.cpp)
        target_link_libraries(OptArgs_Test ion-analysis ${GTEST_BOTH_LIBRARIES} pthread)
        add_test(OptArgsTest OptArgs_Test --gtest_output=xml:./)

        add_executable(H5File_Test utest/H5File_Test.cpp)
        target_link_libraries(H5File_Test ion-analysis ${GTEST_BOTH_LIBRARIES} pthread)
        #add_test(H5FileTest H5File_Test --gtest_output=xml:./)

        add_executable(OptionArgs_Test utest/OptionArgs_Test.cpp)
        target_link_libraries(OptionArgs_Test ion-analysis ${GTEST_BOTH_LIBRARIES} pthread)
        add_test(OptionArgsTest OptionArgs_Test --gtest_output=xml:./)

        add_executable(BitHandler_Test utest/BitHandler_Test.cpp)
        target_link_libraries(BitHandler_Test ion-analysis ${GTEST_BOTH_LIBRARIES} pthread)
        add_test(BitHandlerTest BitHandler_Test --gtest_output=xml:./)

        add_executable(SFFTrim_Test utest/SFFTrim_Test.cpp)
        target_link_libraries(SFFTrim_Test ion-analysis ${GTEST_BOTH_LIBRARIES})
        add_test(SFFTrimTest SFFTrim_Test --gtest_output=xml:./)
endif()

#files used for configuration
#not actually source files at all
install(FILES "${PROJECT_SOURCE_DIR}/config/DefaultTFs.conf" DESTINATION ${ION_INSTALL_PREFIX}/config RENAME "DefaultTFs.conf.dist")
install(FILES "${PROJECT_SOURCE_DIR}/config/exclusionMask_314.bin" DESTINATION ${ION_INSTALL_PREFIX}/config)
install(FILES "${PROJECT_SOURCE_DIR}/config/exclusionMask_316.bin" DESTINATION ${ION_INSTALL_PREFIX}/config)
install(FILES "${PROJECT_SOURCE_DIR}/config/exclusionMask_318.bin" DESTINATION ${ION_INSTALL_PREFIX}/config)
install(FILES "${PROJECT_SOURCE_DIR}/config/exclusionMask_324.bin" DESTINATION ${ION_INSTALL_PREFIX}/config)
install(FILES "${PROJECT_SOURCE_DIR}/config/excludeMask_314" DESTINATION ${ION_INSTALL_PREFIX}/config)
install(FILES "${PROJECT_SOURCE_DIR}/config/excludeMask_316" DESTINATION ${ION_INSTALL_PREFIX}/config)
install(FILES "${PROJECT_SOURCE_DIR}/config/excludeMask_318" DESTINATION ${ION_INSTALL_PREFIX}/config)
install(FILES "${PROJECT_SOURCE_DIR}/config/excludeMask_324" DESTINATION ${ION_INSTALL_PREFIX}/config)
install(FILES "${PROJECT_SOURCE_DIR}/config/phredTable.txt_314" DESTINATION ${ION_INSTALL_PREFIX}/config)
install(FILES "${PROJECT_SOURCE_DIR}/config/phredTable.txt_316" DESTINATION ${ION_INSTALL_PREFIX}/config)
install(FILES "${PROJECT_SOURCE_DIR}/config/phredTable.txt_318" DESTINATION ${ION_INSTALL_PREFIX}/config)
install(FILES "${PROJECT_SOURCE_DIR}/config/gopt_314.param" DESTINATION ${ION_INSTALL_PREFIX}/config)
install(FILES "${PROJECT_SOURCE_DIR}/config/gopt_316.param" DESTINATION ${ION_INSTALL_PREFIX}/config)
install(FILES "${PROJECT_SOURCE_DIR}/config/gopt_318.param" DESTINATION ${ION_INSTALL_PREFIX}/config)
install(FILES "${PROJECT_SOURCE_DIR}/config/gopt_900.param" DESTINATION ${ION_INSTALL_PREFIX}/config)

# perl modules used by plugins for json file parsing
install(FILES "${PROJECT_SOURCE_DIR}/../external/perl/common-sense-3.4.tar.gz" DESTINATION "/tmp/pModIn")
install(FILES "${PROJECT_SOURCE_DIR}/../external/perl/JSON-2.53.tar.gz" DESTINATION "/tmp/pModIn")
install(FILES "${PROJECT_SOURCE_DIR}/../external/perl/JSON-XS-2.32.tar.gz" DESTINATION "/tmp/pModIn")
# perl modules used by plugins for ???
install(FILES "${PROJECT_SOURCE_DIR}/../external/perl/autodie-2.10.tar.gz" DESTINATION "/tmp/pModIn")
install(FILES "${PROJECT_SOURCE_DIR}/../external/perl/Carp-Assert-0.20.tar.gz" DESTINATION "/tmp/pModIn")
install(FILES "${PROJECT_SOURCE_DIR}/../external/perl/IO-All-0.44.tar.gz" DESTINATION "/tmp/pModIn")
install(FILES "${PROJECT_SOURCE_DIR}/../external/perl/IPC-System-Simple-1.21.tar.gz" DESTINATION "/tmp/pModIn")
install(FILES "${PROJECT_SOURCE_DIR}/../external/perl/List-MoreUtils-0.33.tar.gz" DESTINATION "/tmp/pModIn")
install(FILES "${PROJECT_SOURCE_DIR}/../external/perl/Log-Log4perl-1.35.tar.gz" DESTINATION "/tmp/pModIn")
install(FILES "${PROJECT_SOURCE_DIR}/../external/perl/Perl6-Slurp-0.050000.tar.gz" DESTINATION "/tmp/pModIn")
install(FILES "${PROJECT_SOURCE_DIR}/../external/perl/Readonly-1.03.tar.gz" DESTINATION "/tmp/pModIn")
install(FILES "${PROJECT_SOURCE_DIR}/../external/perl/Regexp-Common-2011121001.tar.gz" DESTINATION "/tmp/pModIn")
install(FILES "${PROJECT_SOURCE_DIR}/../external/perl/Statistics-Descriptive-3.0300.tar.gz" DESTINATION "/tmp/pModIn")
install(FILES "${PROJECT_SOURCE_DIR}/../external/perl/Statistics-LineFit-0.07.tar.gz" DESTINATION "/tmp/pModIn")

install(FILES "${PROJECT_SOURCE_DIR}/Analysis.1" DESTINATION share/man/man1)

if(NOT ION_USE_SYSTEM_ARMADILLO)
   install(FILES "${PROJECT_SOURCE_DIR}/../external/armadillo-3.0.2/lib/libarmadillo.so.3" DESTINATION lib)
   install(FILES "${PROJECT_SOURCE_DIR}/../external/armadillo-3.0.2/lib/libarmadillo.so.3.0.2" DESTINATION lib)
endif()

include(../buildTools/cmake/CMakeLists.cpack.txt)
#% nice to automate this
#Dependency Notes:
#
# The matePairIndividualTags plugin requires these packages:
#	emboss-data,emboss-lib,libnucleus6,libajax6
# The emboss package itself is not installed because of a filename conflict with
# /usr/bin/tmap.
set(CPACK_DEBIAN_PACKAGE_DEPENDS "libatlas3gf-base,
    libblas3gf,
    libc6,
    libgcc1,
    libgfortran3,
    liblapack3gf,
    libstdc++6,
    openjdk-6-jre,
    libgsl0ldbl,
    ion-gpu")

set(CPACK_DEBIAN_PACKAGE_BREAKS "ion-gpu (<= 2.2)")
set(CPACK_DEBIAN_PACKAGE_REPLACES "ion-gpu (<= 2.2)")

set(CPACK_PACKAGE_DESCRIPTION "ion-analysis provides the command line workflow and supporting tools to process raw DAT files into SFF and fastq files.")
set(CPACK_DEBIAN_PACKAGE_CONTROL_EXTRA
    ${CMAKE_CURRENT_BINARY_DIR}/debian/postinst
    ${CMAKE_CURRENT_BINARY_DIR}/debian/prerm
)
include(CPack)
