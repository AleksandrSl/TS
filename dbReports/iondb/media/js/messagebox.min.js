//Copyright (C) 2012 Ion Torrent Systems, Inc. All Rights Reserved
// requires jquery, underscore.js, and backbone.js
$(function(){Message=Backbone.Model.extend({url:function(){return"/rundb/api/v1/message/"+this.get("id")+"/"},close:function(){this.destroy({wait:!0})}}),MessageList=Backbone.Collection.extend({model:Message,binding:"",url:function(){var e="&route=";return this.binding&&(e="&route__startswith="+this.binding),"/rundb/api/v1/message/?status=unread&id__gt="+this.max_id()+e},parse:function(e){return e.objects},max_id:function(){return this.length?this.at(0).get("id"):0},comparator:function(e){return-1*e.get("id")}}),MessageView=Backbone.View.extend({className:"alert",template:function(e){return'<a class="close">x</a>'+e.body},events:{"click a.close":"close"},initialize:function(){this.render()},close:function(){var e=this;$(this.el).slideUp(function(){e.remove()}),this.model.close()},render:function(){this.$el.html(this.template(this.model.toJSON()))}}),MessageBox=Backbone.View.extend({initialize:function(){_.bindAll(this,"render","addOne","addAll","poll","update"),this.setElement($("#global_messages")),this.collection=new MessageList(this.options.models),this.collection.bind("add",this.addOne,this),this.collection.bind("reset",this.addAll,this),this.render(),this.poll_interval=1e4,this.poll_clock=setTimeout(this.update,this.poll_interval)},render:function(){this.collection.length&&(this.addAll(),this.$el.show())},addOne:function(e){var t=new MessageView({model:e});t.$el.hide(),this.$el.prepend(t.el),t.$el.slideDown()},addAll:function(){var e=this.collection.map(function(e){return(new MessageView({model:e})).el});this.$el.prepend(e)},poll:function(){this.poll_clock!=null&&(this.poll_clock=setTimeout(this.update,this.poll_interval))},update:function(){this.collection.fetch({add:!0,success:this.poll,error:this.poll})}})});