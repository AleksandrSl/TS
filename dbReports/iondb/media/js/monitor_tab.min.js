$(function(){function e(e){e.preventDefault(),$("#error-messages").hide().empty(),url=$(e.target).attr("href"),$("body #modal_review_plan").remove(),$.get(url,function(e){return $("body").append(e),$("#modal_review_plan").modal("show"),!1}).done(function(e){console.log("success:",url)}).fail(function(e){$("#error-messages").empty().show(),$("#error-messages").append('<p class="error">ERROR: '+e.responseText+"</p>"),console.log("error:",e)}).always(function(e){})}CardRunView=Backbone.View.extend({className:"run",events:{"click .review-plan":"review_plan_"},initialize:function(){_.bindAll(this,"render","review_plan_","destroy_view"),console.log("Card view initialized."),this.model.bind("change",this.render),this.model.bind("remove",this.destroy_view)},template:Hogan.compile($("#monitor_experiment_template").html()),render:function(){console.log(this.model.changedAttributes()),this.$('[rel="tooltip"]').tooltip("hide");if(this.model.reports.length>0){var e=this.model.reports.at(0);console.log(e);var t=e.get("analysis_metrics"),n=e.get("quality_metrics")}var r=this.model.get("ftpStatus");context={exp:this.model.toJSON(),prettyExpName:TB.prettyPrintRunName(this.model.get("expName")),king_report:e&&e.toJSON(),date_string:kendo.toString(this.model.get("date"),"MM/dd/yy hh:mm tt"),bead_loading:t&&Math.round(t.bead/(t.total_wells-t.excluded)*1e3)/10,bead_live:t&&Math.round(t.live/t.bead*1e3)/10,bead_lib:t&&Math.round(t.lib/t.live*1e3)/10,usable_seq:t&&n&&Math.round(n.q0_reads/t.lib*1e3)/10,progress_flows:Math.round((r=="Complete"?1:r/100)*this.model.get("flows")),progress_percent:r=="Complete"?100:r,is_proton:this.model.get("chipType")=="900",in_progress:r!="Complete"};var n=this.model.get("qcThresholds"),i=context.king_report&&context.king_report.libmetrics&&context.king_report.libmetrics.aveKeyCounts,s=n["Bead Loading (%)"],o=n["Key Signal (1-100)"],u=n["Usable Sequence (%)"];$(this.el).html(this.template.render(context)),this.$(".bead-loading").strength(context.bead_loading,s,context.bead_loading,"Loading"),this.$(".bead-live").strength(context.bead_live,undefined,context.bead_live,"Live ISPs"),this.$(".bead-lib").strength(context.bead_lib,undefined,context.bead_lib,"Library ISPs"),this.$(".key-signal").strength(i,o,i,"Key Signal",""),this.$(".usable-sequence").strength(context.usable_seq,u,context.usable_seq,"Usable Seq")},review_plan_:function(t){e(t)},destroy_view:function(){console.log("Destroying card run view"),this.undelegateEvents(),$(this.el).removeData().unbind(),this.remove(),Backbone.View.prototype.remove.call(this)}}),TableRunView=Backbone.View.extend({tagName:"tr",initialize:function(){_.bindAll(this,"render")},template:Hogan.compile($("#monitor_experiment_table_template").html()),render:function(){}}),RunListView=Backbone.View.extend({el:$("#monitor_view"),events:{"click #view_full":"view_full","click #view_table":"view_table","click #live_button":"toggle_live_update"},initialize:function(){_.bindAll(this,"render","addRun","setup_full_view","view_full","setup_table_view","view_table","start_update","toggle_live_update","clear_update","poll_update","countdown_update","appendRun"),this.table_view=null,this.pager=new PaginatedView({collection:this.collection,el:$("#pager")}),this.pager.render(),this.collection.bind("add",this.addRun),this.collection.bind("reset",this.render),this.router=this.options.router,this.router.on("route:full_view",this.view_full),this.router.on("route:table_view",this.view_table),this.live_update=setTimeout(this.poll_update,1e4)},render:function(){return console.log("Rendering RunListView"),console.log(this.collection),$("#main_list").empty(),this.collection.each(this.appendRun),this},addRun:function(e,t,n){console.log("Adding run"),console.log(n),n=n||{index:0};var r=new this.RunView({model:e});r.render(),$(r.el).hide(),this.$("#main_list").children()==0?$("#main_list > div",this.el).append(r.el):$("#main_list > div",this.el).eq(n.index).before(r.el),$(r.el).slideDown(500)},appendRun:function(e){var t=new this.RunView({model:e});t.render(),$("#main_list",this.el).append(t.el)},setup_full_view:function(){$("#data_panel").html('<div id="main_list"></div>'),this.RunView=CardRunView,$("#view_table").removeClass("active"),$("#view_full").addClass("active"),$("#pager").show()},view_full:function(){this.table_view!==!1&&(this.table_view=!1,this.router.navigate("full"),this.setup_full_view(),this.render())},clear_update:function(){this.live_update&&(clearTimeout(this.live_update),this.live_update=null)},start_update:function(){this.clear_update(),this.live_update=!0,this.poll_update()},countdown_update:function(){this.live_update=setTimeout(this.poll_update,1e4)},poll_update:function(){this.live_update&&this.collection.fetch({update:!0,at:0,complete:this.countdown_update})},toggle_live_update:function(){this.live_update!==null?(this.clear_update(),this.$("#live_button").addClass("btn-success").text("Auto Update"),this.$("#update_status").text("Page is static until refreshed")):(this.start_update(),this.$("#live_button").removeClass("btn-success").text("Stop Updates"),this.$("#update_status").text("Page is updating automatically"))},setup_table_view:function(){$("#data_panel").html('<div id="main_table"  class="table-dense"></div>'),this.RunView=TableRunView,$("#view_full").removeClass("active"),$("#view_table").addClass("active"),$("#pager").hide(),$("#main_table").kendoGrid({dataSource:{type:"json",transport:{read:{url:this.collection.baseUrl,contentType:"application/json; charset=utf-8",type:"GET",dataType:"json"},parameterMap:function(e){return buildParameterMap(e)}},schema:{data:"objects",total:"meta.total_count",model:{fields:{id:{type:"number"},pgmName:{type:"string"},expName:{type:"string"},library:{type:"string"},flows:{type:"number"},barcodeId:{type:"string"},chipDescription:{type:"string"},star:{type:"boolean"},date:{type:"string"},resultDate:{type:"string"},ftpStatus:{type:"string"},storageOptions:{type:"string"},notes:{type:"string"}}}},serverSorting:!0,serverFiltering:!0,serverPaging:!0,pageSize:this.collection.limit,requestStart:function(e){$("#main_table *[rel=tooltip]").tooltip("destroy"),$("body div.tooltip").remove()}},height:"auto",groupable:!1,scrollable:!1,selectable:!1,sortable:!0,pageable:!0,columns:[{field:"star",title:" ",width:"3%",template:kendo.template($("#favoriteColumnTemplate").html())},{field:"pgmName",width:"6%",title:"Instrument",template:'<span rel="tooltip" title="#= pgmName#">#=pgmName # </span>'},{field:"displayName",width:"17%",title:"Run Name",template:kendo.template($("#expNameLinkTemplate").html())},{field:"ftpStatus",title:"Status",template:kendo.template($("#statusColumnTemplate").html())},{field:"date",title:"Started",template:'#= kendo.toString(new Date(Date._parse(date)),"MM/dd/yy hh:mm tt") #'},{field:"resultDate",title:"Result Date",template:'#= kendo.toString(new Date(Date._parse(resultDate)),"MM/dd/yy hh:mm tt") #'},{field:"chipDescription",width:"5%",title:"Chip"},{field:"library",title:"Ref Genome",width:"6%",template:"#= TB.toString(library) #"},{field:"barcodeId",title:"Barcode",width:"5%",template:"#= TB.toString(barcodeId) #"},{title:"Loading",sortable:!1,width:"5%",template:kendo.template($("#ispLoadingColumnTemplate").html())},{title:"Live ISPs",sortable:!1,width:"4%",template:kendo.template($("#ispLiveColumnTemplate").html())},{title:"Library ISPs",sortable:!1,width:"4%",template:kendo.template($("#ispLibraryColumnTemplate").html())},{title:"Key Signal",sortable:!1,width:"5%",template:kendo.template($("#keySignalColumnTemplate").html())},{title:"Usable Seq",sortable:!1,width:"5%",template:kendo.template($("#usableSequenceColumnTemplate").html())}],dataBound:function(t){function n(e){function t(e,t){e.off(),attributes=$.extend(t,{id:e.data("id")});var r=kendo.template($("#favoriteColumnTemplate").html());parentTD=e.parent(),parentTD.html(r({data:attributes})),$(".toggle-star",parentTD).click(function(e){e.preventDefault(),n($(this))})}url=e.attr("href"),attributes={star:!e.data("star")},$.ajax({url:url,type:"PATCH",data:JSON.stringify(attributes),contentType:"application/json",success:t(e,attributes)}),url=null,attributes=null}$(".toggle-star").click(function(e){e.preventDefault(),n($(this))}),$(".review-plan").click(e),$("body div.tooltip").remove(),initTooltip(this.content)},requestStart:function(e){$("#main_table").find('[rel="tooltip"]').tooltip("hide")}})},view_table:function(){this.table_view!==!0&&(this.table_view=!0,this.router.navigate("table"),this.setup_table_view())}})});