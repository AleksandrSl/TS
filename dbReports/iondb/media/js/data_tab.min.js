String.prototype.endsWith=function(e){return this.indexOf(e,this.length-e.length)!==-1};var mainRuns=null;$(function(){function t(e){console.log("event ",e);e.preventDefault();$("#error-messages").hide().empty();url=$(e.currentTarget).attr("href");$("body #modal_experiment_edit").remove();$.get(url,function(t){$("body").append(t);$("#modal_experiment_edit").data("source",e.currentTarget);$("#modal_experiment_edit").modal("show");return false}).done(function(e){console.log("success:",url)}).fail(function(e){$("#error-messages").empty().show();$("#error-messages").append('<p class="error">ERROR: '+e.responseText+"</p>");console.log("error:",e)}).always(function(e){});url=null}var e=new Date;ReportView=Backbone.View.extend({tagName:"tr",events:{"click .icon-thumbs-up":"toggle_representative","click .dm-actions":"dm_actions"},initialize:function(){_.bindAll(this,"render","post_action","toggle_representative","destroy_view","dm_actions");this.model.bind("change",this.render);this.model.bind("remove",this.destroy_view)},template:Hogan.compile($("#report_template").html()),render:function(){console.log("Rendering report "+this.model.id);$(this.el).html(this.template.render({report:this.model.toJSON(),total_q20bp:function(){return this.quality_metrics&&precisionUnits(this.quality_metrics.q20_bases)},total_q0bp:function(){return this.quality_metrics&&precisionUnits(this.quality_metrics.q0_bases)},reads_q20:function(){return this.quality_metrics&&precisionUnits(this.quality_metrics.q0_reads)},read_length:function(){return this.quality_metrics&&Math.round(this.quality_metrics.q0_mean_read_length)},date_string:kendo.toString(this.model.get("timeStamp"),"MM/dd/yy hh:mm tt")}))},destroy_view:function(){console.log("Destroying report view");this.undelegateEvents();$(this.el).removeData().unbind();this.remove();Backbone.View.prototype.remove.call(this)},dm_actions:function(e){e.preventDefault();$(e.currentTarget).closest(".dropdown-menu").parent().children(".dropdown-toggle").dropdown("toggle");$("body #modal_dm_actions").remove();var t="/configure/services/dm_actions/"+this.model.id+"/";$.get(t,function(e){$("body").append(e);$("#modal_dm_actions").modal("show")});return false},post_action:function(e,t,n){console.log("Creating Dialog");var r="/report/action/"+this.model.id+"/"+e;var i=window.location.href;var s=function(){window.location.href=i;window.location.reload(true)};var o=function(e,t,n){$.post(e,t,n).error(function(){$("#modal_data_management_errors").empty().append("<p>Unable to complete task. Check the report log for more details.</p>").removeClass("hide");setTimeout(function(){n()},2e3)})};if(n){$("#modal_data_management .modal-header h3").text("Report "+this.model.get("resultsName")+" will now "+t+". Proceed?");$("#modal_data_management_errors").addClass("hide").empty();$("#modal_data_management .btn-primary").click(function(e){e.preventDefault();$(e.target).addClass("disabled");$(e.target).unbind("click");var t={};t.comment=$.trim($("#data_management_comments").val())||"No Comment";o(r,t,s)});$("#modal_data_management").modal("show")}else{data={};o(r,data,s)}return false},toggle_representative:function(){if(this.model.get("representative")){this.model.patch({representative:false})}else{this.model.patch({representative:true})}}});ReportListView=Backbone.View.extend({events:{"click .reports-show-more":"toggleMore"},initialize:function(){_.bindAll(this,"render","addReport","toggleMore","showMore","hideMore","destroy_view");this.is_open=false;this.collection.bind("add",this.addReport);this.collection.bind("reset",this.render);this.collection.bind("change",this.render);this.collection.bind("remove",this.destroy_view);this.render()},template:Hogan.compile($("#report_list_template").html()),render:function(){$(this.el).html(this.template.render({count:this.collection.length,more_reports:this.collection.length>2,is_open:this.is_open}));this.elBody=this.$(".reports-top");this.elMore=this.$(".reports-more");this.elBody.empty();this.collection.each(function(e,t){this.addReport(e,t)},this);if(this.is_open){this.showMore()}},addReport:function(e,t){if(t===undefined){t=this.collection.length}var n=new ReportView({model:e});n.render();if(t<2){this.elBody.append(n.el)}else{this.elMore.append(n.el)}},hideMore:function(){this.elMore.hide();this.$(".reports-show-more").html("Show all "+this.collection.length+" reports")},showMore:function(){this.elMore.show();this.$(".reports-show-more").html("Hide")},toggleMore:function(){if(this.is_open){console.log("Hiding");this.is_open=false;this.hideMore()}else{console.log("Showing");this.is_open=true;this.showMore()}return false},destroy_view:function(){console.log("Destroying report list view");this.undelegateEvents();$(this.el).removeData().unbind();this.remove();Backbone.View.prototype.remove.call(this)}});CardRunView=Backbone.View.extend({className:"run",events:{"click .reanalyze-run":"reanalyze","click .edit-run":"edit","click .completedrun-star":"toggle_star","click .storage-exempt":function(e){var t=$(e.currentTarget).is(":checked");$.ajax({url:"/configure/services/preserve_data/",dataType:"json",type:"POST",async:false,contentType:"application/json; charset=utf-8",data:"exppk="+this.model.id+"&keep="+t+"&type=sig",success:function(e){console.log(e)}})}},initialize:function(){_.bindAll(this,"render","reanalyze","edit","toggle_star","set_storage","destroy_view");this.model.bind("change",this.render);this.model.bind("remove",this.destroy_view);this.reports=new ReportListView({collection:this.model.reports})},template:Hogan.compile($("#experiment_template").html()),render:function(){console.log("Rendering "+this.model.id);this.$('[rel="tooltip"]').tooltip("hide");var e=this.model.get("ftpStatus");$(this.el).html(this.template.render({exp:this.model.toJSON(),prettyExpName:TB.prettyPrintRunName(this.model.get("expName")),date_string:kendo.toString(this.model.get("date"),"MM/dd/yy hh:mm tt"),king_report:this.model.reports.length>0?this.model.reports.at(0).toJSON():null,progress_flows:Math.round((e=="Complete"?1:e/100)*this.model.get("flows")),progress_percent:e=="Complete"?100:e,in_progress:!isNaN(parseInt(e)),is_proton:this.model.get("chipInstrumentType")=="proton"}));this.reports.render();this.$(".table_container").html(this.reports.el)},reanalyze:function(){console.log("Reanalyze run "+this.model.id)},edit:function(e){console.log("Edit run "+this.model.id);console.log("event ",e);e.preventDefault();$("#error-messages").hide().empty();url=$(e.currentTarget).attr("href");$("body #modal_experiment_edit").remove();$.get(url,function(t){$("body").append(t);$("#modal_experiment_edit").data("source",e.currentTarget);$("#modal_experiment_edit").modal("show");return false}).done(function(e){console.log("success:",url)}).fail(function(e){$("#error-messages").empty().show();$("#error-messages").append('<p class="error">ERROR: '+e.responseText+"</p>");console.log("error:",e)});return false},toggle_star:function(){if(this.model.get("star")){this.model.patch({star:false})}else{this.model.patch({star:true})}},set_storage:function(e){this.model.patch({storage_options:e})},destroy_view:function(){console.log("Destroying card run view");this.undelegateEvents();$(this.el).removeData().unbind();this.remove();Backbone.View.prototype.remove.call(this)}});RunView=Backbone.View.extend({edit:function(e){console.log("Edit run "+this.model.id);t(e)}});TableRunView=RunView.extend({tagName:"tr",events:{},initialize:function(){_.bindAll(this);this.model.bind("change",this.render)},template:Hogan.compile($("#experiment_table_template").html()),render:function(){},toggle_star:function(){}});DevRunView=Backbone.View.extend({tagName:"tr",events:{"click .completedrun-star":"toggle_star","click .edit-run":"edit"},initialize:function(){_.bindAll(this,"render","destroy_view","toggle_star","edit");this.model.bind("change",this.render);this.model.bind("remove",this.destroy_view)},template:Hogan.compile($("#experiment_table_template").html()),render:function(){console.log("Rendering DevRunView");console.log(this.model);var e=this.model.reports.length>0?this.model.reports.at(0).toJSON():null;var t=this.model.get("ftpStatus");this.$el.html(this.template.render({exp:this.model.toJSON(),run_date_string:this.model.get("date").toString("MM/dd/yy"),result_date_string:this.model.get("resultDate").toString("MM/dd/yy"),king_report:e,progress_flows:Math.round((t=="Complete"?1:t/100)*this.model.get("flows")),progress_percent:t=="Complete"?100:t,in_progress:!isNaN(parseInt(t)),total_q20bp:function(){return e&&e.quality_metrics&&precisionUnits(e.quality_metrics.q20_bases)},total_q0bp:function(){return e&&e.quality_metrics&&precisionUnits(e.quality_metrics.q0_bases)},reads_q20:function(){return e&&e.quality_metrics&&precisionUnits(e.quality_metrics.q0_reads)},read_length:function(){return e&&e.quality_metrics&&precisionUnits(e.quality_metrics.q0_mean_read_length)}}))},edit:function(e){e.preventDefault();$("#error-messages").hide().empty();url="/data/experiment/"+this.model.id+"/";$("body #modal_experiment_edit").remove();$.get(url,function(e){$("body").append(e);$("#modal_experiment_edit").modal("show")}).fail(function(e){$("#error-messages").empty().show();$("#error-messages").append('<p class="error">ERROR: '+e.responseText+"</p>");console.log("error:",e)})},toggle_star:function(){if(this.model.get("star")){this.model.patch({star:false})}else{this.model.patch({star:true})}},destroy_view:function(){console.log("Destroying card run view");this.undelegateEvents();$(this.el).removeData().unbind();this.remove();Backbone.View.prototype.remove.call(this)}});RunListView=RunView.extend({el:$("#data_view"),events:{"change .search-field":"search","click #search_text_go":"search","click #clear_filters":"clear_filters","click #view_full":"view_full","click #view_table":"view_table","click #view_old_table":"view_old_table","click #live_button":"toggle_live_update","click #download_csv":"csv_download","click .sort_link":"sort"},initialize:function(){_.bindAll(this,"render","addRun","search","setup_full_view","view_full","setup_table_view","view_table","start_update","toggle_live_update","clear_update","poll_update","csv_download","countdown_update","appendRun","view_old_table","setup_old_table_view");$(".chzn-select").chosen({no_results_text:"No results matched",allow_single_deselect:true});$(".chzn-drop").css("width",$(".chzn-select").outerWidth()-2);$(".chzn-search input").css("width",$(".chzn-select").outerWidth()*.815);$("#rangeA").daterangepicker({dateFormat:"mm/dd/yy"});this.current_view=null;this.collection.bind("add",this.addRun);this.collection.bind("reset",this.render);this.pager=null;this.router=this.options.router;this.router.on("route:full_view",this.view_full);this.router.on("route:table_view",this.view_table);this.router.on("route:old_table",this.view_old_table);this.live_update=null},render:function(){console.log("Rendering RunListView");console.log(this.collection);$("#main_list").empty();console.log("Emptied");this.collection.each(this.appendRun);return this},addRun:function(e,t,n){n=n||{index:0};console.log(n);var r=new this.RunView({model:e});r.render();$("#main_list > div",this.el).eq(n.index).before(r.el)},appendRun:function(e,t){console.log(e+" "+t);var n=new this.RunView({model:e});n.render();$("#main_list",this.el).append(n.el)},setup_full_view:function(){if(this.pager!==null){this.pager.destroy_view()}$("#data_panel").html('<div id="main_list"></div><div id="pager" class="k-pager-wrap" style="text-align: left;"></div>');this.RunView=CardRunView;$("#view_table").removeClass("active");$("#view_old_table").removeClass("active");$("#view_full").addClass("active");this.pager=new PaginatedView({collection:this.collection,el:$("#pager")});this.pager.render();$("#pager").show()},view_full:function(){if(!(this.current_view==="full")){this.current_view="full";this.router.navigate("full");this.setup_full_view();this.render()}},setup_table_view:function(){console.log("setup_view_dev");if(this.pager!==null){this.pager.destroy_view()}var e=$("#experiment_list_table_template").html();$("#data_panel").html(e);this.RunView=DevRunView;$("#view_old_table").removeClass("active");$("#view_table").addClass("active");$("#view_full").removeClass("active");this.pager=new PaginatedView({collection:this.collection,el:$("#pager")});this.pager.render();$("#pager").show()},view_old_table:function(){if(!(this.current_view==="old_table")){this.current_view="old_table";console.log("view_old_table");this.router.navigate("old_table");this.setup_old_table_view();this.render()}},setup_old_table_view:function(){$("#data_panel").html('<div id="main_table" class="table-dense"></div>');this.RunView=TableRunView;$("#view_old_table").addClass("active");$("#view_table").removeClass("active");$("#view_full").removeClass("active");$("#pager").hide();$("#main_table").kendoGrid({dataSource:{type:"json",transport:{read:{url:this.collection.baseUrl,contentType:"application/json; charset=utf-8",type:"GET",dataType:"json"},parameterMap:function(e){return buildParameterMap(e)}},schema:{data:"objects",total:"meta.total_count",model:{fields:{id:{type:"number"},expName:{type:"string"},library:{type:"string"},flows:{type:"number"},barcodeId:{type:"string"},chipDescription:{type:"string"},star:{type:"boolean"},date:{type:"string"},resultDate:{type:"string"},ftpStatus:{type:"string"}}}},serverSorting:true,serverFiltering:true,serverPaging:true,pageSize:this.collection.limit,filter:this._table_filter(),requestStart:function(e){$("#main_table *[rel=tooltip]").tooltip("destroy");$("body div.tooltip").remove()}},height:"auto",groupable:false,scrollable:false,selectable:false,sortable:true,pageable:true,columns:[{field:"star",title:" ",width:"26px",template:kendo.template($("#favoriteColumnTemplate").html())},{field:"expName",title:"Run Name",template:'<span rel="tooltip" title="#= expName#">#=TB.prettyPrintRunName(expName) # </span>'},{field:"sample",width:"10%",title:"Sample",template:'<span rel="tooltip" title="#= TB.toString(sample)#">#= TB.toString(sample) #<span>'},{title:"App.",width:"32px",sortable:false,template:'# if (plan) { # <span class="#=plan.runType#" rel="tooltip" title="#=TB.runTypeDescription(plan.runType)#"></span> # } #'},{field:"date",title:"Run",width:"60px",template:'<span rel="tooltip" title="#= kendo.toString(new Date(Date._parse(date)),"MM/dd/yy hh:mm tt")#">#= kendo.toString(new Date(Date._parse(date)),"MM/dd/yy") # </span>'},{field:"resultDate",width:"60px",title:"Analysis",template:'<span rel="tooltip" title="#= kendo.toString(new Date(Date._parse(resultDate)),"MM/dd/yy hh:mm tt")#">#= kendo.toString(new Date(Date._parse(resultDate)),"MM/dd/yy") # </span>'},{field:"ftpStatus",width:"90px",title:"Status",template:kendo.template($("#statusColumnTemplate").html())},{field:"chipDescription",width:"40px",title:"Chip"},{field:"results",title:"Report Name",sortable:false,template:kendo.template($("#reportNameColumnTemplate").html())},{field:"library",title:"Reference",width:"5%",template:'<span rel="tooltip" title="#= TB.toString(library)#">#= TB.toString(library) #</span>'},{field:"barcodeId",title:"Barcode",width:"10%",template:'<span rel="tooltip" title="#= TB.toString(barcodeId)#">#= TB.toString(barcodeId) #</span>'},{field:"flows",width:"40px",title:"Flows"},{title:"Total Reads",sortable:false,width:"46px",template:kendo.template($("#totalReadsColumnTemplate").html())},{title:"Mean Read Len.",sortable:false,width:"36px",template:kendo.template($("#meanReadLengthColumnTemplate").html())},{title:"Q20 Bases",width:"46px",sortable:false,template:kendo.template($("#q20BasesColumnTemplate").html())},{title:"Output",width:"46px",sortable:false,template:kendo.template($("#outputColumnTemplate").html())},{title:" ",sortable:false,width:"24px",template:kendo.template($("#actionColumnTemplate").html())}],dataBound:function(e){function n(e){function t(e,t){e.off();attributes=$.extend(t,{id:e.data("id")});var r=kendo.template($("#favoriteColumnTemplate").html());parentTD=e.parent();parentTD.html(r({data:attributes}));$(".toggle-star",parentTD).click(function(e){e.preventDefault();n($(this))})}url=e.attr("href");attributes={star:!e.data("star")};$.ajax({url:url,type:"PATCH",data:JSON.stringify(attributes),contentType:"application/json",success:t(e,attributes)});url=null;attributes=null}$(".toggle-star").click(function(e){e.preventDefault();n($(this))});$(".edit-run").click(t);$("body div.tooltip").remove();initTooltip($(this.content))}});var e=$("#main_table");_.each({"Run Name":"Name of this run",Sample:"Sample name for the run","App.":"Application type",Run:"Run start time",Analysis:"Analysis start time",Status:"Analysis status",Chip:"Chip type","Report Name":"Name of this run's selected report",Reference:"Reference sequence",Barcode:"Barcode kit used",Flows:"Number of flows analyzed","Total Reads":"Total number of all reads","Mean Read Len.":"Mean length of all reads","Q20 Bases":"Total number of Q20 quality bases",Output:"Total number of all bases"},function(t,n){e.find('th[data-title="'+n+'"] a').tooltip({title:t})})},view_table:function(){if(!(this.current_view==="table")){this.current_view="table";this.router.navigate("table");this.setup_table_view();this.render()}},clear_update:function(){if(this.live_update){clearTimeout(this.live_update);this.live_update=null}},start_update:function(){this.clear_update();this.live_update=true;this.poll_update()},countdown_update:function(){clearTimeout(this.live_update);this.live_update=setTimeout(this.poll_update,2e4)},poll_update:function(){if(this.live_update){if(this.current_view==="old_table")refreshKendoGrid("#main_table");this.collection.fetch({update:true,at:0,complete:this.countdown_update})}},toggle_live_update:function(){if(this.live_update!==null){this.clear_update();this.$("#live_button").addClass("btn-success").text("Auto Update");this.$("#update_status").text("Page is static until refreshed")}else{this.start_update();this.$("#live_button").removeClass("btn-success").text("Stop Updates");this.$("#update_status").text("Page is updating automatically")}},clear_filters:function(){window.location.reload(true)},sort:function(e){var t=$(e.target).data("name");var n=$("#order_by").val();console.log("Sorting "+t);console.log("Current sort "+n);if(n==t){console.log("negate");$("#order_by").val("-"+t)}else if(n=="-"+t){console.log("default");$("#order_by").val("-resultDate")}else{console.log("set");$("#order_by").val(t)}console.log($("#order_by").val());$("#order_by").trigger("liszt:updated");this.search()},_get_query:function(){var e={all_date:$("#rangeA").val(),all_text:$("#search_text").val(),result_status:$("#id_status").val(),star:$("#id_star:checked").exists(),results__projects__name:$("#id_project").val(),samples__name:$("#id_sample").val(),chipType:$("#id_chip").val(),pgmName:$("#id_pgm").val(),results__eas__reference:$("#id_reference").val(),flows:$("#id_flows").val(),order_by:$("#order_by").val()};if(e["all_date"]){if(!/ - /.test(e["all_date"])){e["all_date"]=e["all_date"]+" - "+e["all_date"]}e["all_date"]=e["all_date"].replace(/ - /," 00:00,")+" 23:59"}if(e["order_by"]=="-resultDate"){e["order_by"]=""}var t={};for(var n in e){if(e[n])t[n]=e[n]}console.log(t);return t},csv_download:function(){var e=this._get_query();e=$.extend({format:"csv"},e);console.log(e);var t=$.param(e);if(t.length>0)t="&"+t;var n="/data/getCSV.csv";jQuery.download(n,e,"POST");return false},_table_filter:function(){var e=this._get_query();var t=[];for(var n in e){if(n in["order_by"])continue;if(e[n]){t.push({field:n,operator:"",value:e[n]})}}return t},search:function(){if(this.current_view==="old_table"){$("#main_table").data("kendoGrid").dataSource.filter(this._table_filter())}this.collection.filtrate(this._get_query())}})})