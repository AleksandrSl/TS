//this file has the JavaScript for the default report
function htmlEscape(e){return String(e).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br/>")}function resizeiFrames(){$(".pluginBlock:visible").each(function(){var e=$(this).contents().height(),t=$(this).parent().css("width");$(this).height()!=e&&$(this).height(e),$(this).width()!=t&&$(this).width(t)}),$(".pluginMajorBlock:visible").each(function(){var e=$(this).contents().find("body").height()+20,t=parseInt($(".section").css("width"),10)-20;$(this).height()!=e&&$(this).height(e),$(this).width()!=t&&$(this).width(t)})}function update_plugin_show(e){$.ajax({type:"POST",url:api_plugin_show_url,data:JSON.stringify(e),contentType:"application/json",datType:"json"})}function pluginStatusLoad(){$("#pluginRefresh").activity({segments:10,width:3,space:2,length:3,color:"#252525",speed:1.5,padding:"3",align:"left"}),$.ajax({type:"GET",url:djangoURL+"?major=true",contentType:"application/json; charset=utf-8",dataType:"json",async:!1,success:function(e){$("#major_blocks").html(""),iframescroll=$.browser.msie?"yes":"no";for(var t=0;t<e.length;t++){var n=plugin_major_template(e[t]),r=$(n).appendTo("#major_blocks"),i=r.find(".plugin_links");for(var s=0;s<e[t].Links.length;s++)i.append('<a href="'+e[t].URL+e[t].Links[s]+'">'+e[t].Links[s]+"</a>");e[t].Files.length==0&&r.append('<div class="section">No plugin output at this time.</div>');for(var o=0;o<e[t].Files.length;o++)r.append('<div class="section"><iframe scrolling="'+iframescroll+'" id="'+e[t].Name+'" class="pluginMajorBlock" src="'+e[t].URL+e[t].Files[o]+'" frameborder="0" height="0px" ></iframe></div>')}},error:function(e,t,n){$("#major_blocks").text("Failed to get Plugin Status"),console.log("Error fetching"+n.url+": "+e.responseText)}}),$("#pluginStatusTable").fadeOut(),$("#pluginStatusTable").html(""),$.ajax({type:"GET",url:djangoURL,contentType:"application/json; charset=utf-8",dataType:"json",async:!1,success:function(e){table_plugin_names=[];for(var t=0;t<e.length;t++){var n=plugin_status_template(e[t]),r=e[t].Name;table_plugin_names.push(r),function(e){$("#pluginStatusTable").append(n).find(".plugin-collapse:last").click(function(){$(this).text($(this).text()=="-"?"+":"-");var t=$(this).closest(".pluginGroup").find(".pluginGroupList"),n=t.is(":visible"),r={};return r[e]=!n,update_plugin_show(r),t.slideToggle(250),!1})}(r)}},error:function(e){$("#pluginStatusTable").text("Failed to get Plugin Status")}}),$("#pluginStatusTable").fadeIn(),$("#pluginRefresh").activity(!1)}function progress_load(){$.ajax({type:"GET",url:reportAPI,contentType:"application/json; charset=utf-8",dataType:"json",async:!1,success:function(e){$("#progress_message").html(e.status),e.status.indexOf("Completed")===0&&(clearInterval($(document).data("report_progress")),e.status==="Completed"&&($("#progress_message").html("The report has been completed. The page will reload in 5 seconds"),setTimeout(function(){location.reload()},1e4)))},error:function(e){$("#progress_message").html("Error checking status")}})}function start_iru(e){console.log(e),pluginAPIJSON={plugin:["IonReporterUploader"],pluginconfig:e},pluginAPIJSON=JSON.stringify(pluginAPIJSON),$.blockUI();var t=$.ajax({type:"POST",url:pluginURL,contentType:"application/json; charset=utf-8",data:pluginAPIJSON,dataType:"json"});t.done(function(e){$.unblockUI(),bootbox.alert("Upload to Ion Reporter has started.",function(){})}),t.fail(function(e){$.unblockUI(),alert("Failed to start IRU upload")})}api_plugin_show_url="/rundb/api/v1/plugin/show/",String.prototype.endsWith=function(e){return this.match(e+"$")==e},$(document).ready(function(){plugin_status_template=kendo.template($("#pluginStatusTemplate").html()),plugin_major_template=kendo.template($("#pluginMajorBlockTemplate").html()),console.log("Get ready"),plugin_dropdown_template=kendo.template($("#pluginDropdownTemplate").html()),djangoPK=$("#report").data("pk"),webLink=$("#report").data("web"),reportAPI="/rundb/api/v1/results/"+djangoPK+"/",djangoURL="/rundb/api/v1/results/"+djangoPK+"/pluginresults/",pluginURL="/rundb/api/v1/results/"+djangoPK+"/plugin/";var e=$.ajax({url:"/rundb/api/v1/plugin/IonReporterUploader/extend/configs/?format=json",type:"GET"}).done(function(e){var t=kendo.template($("#iru-list-tmpl").html()),n=t(e);$("#iru-list").html(n),$("#iru-button").on("click",".iru-account",function(t){t.preventDefault();var n=$(this).data("id"),r;$.each(e,function(e,t){t.id===n&&(r=t)}),r.launchoption="upload_only";var i=!1,s=$.ajax({type:"GET",url:djangoURL,contentType:"application/json; charset=utf-8",async:!1,dataType:"json"});s.done(function(e){$.each(e,function(e,t){t.Name==="IonReporterUploader"&&(i=!0)})});var o="";bootbox.dialog("Are you sure you want to upload this report to Ion Reporter?",[{label:"Upload just BAM","class":"btn-primary",callback:function(){r.upload="bam_only",start_iru(r)}},{label:"Upload just VCF","class":"btn-primary",callback:function(){r.upload="vcf_only",start_iru(r)}},{label:"Upload BAM & VCF","class":"btn-primary",callback:function(){r.upload="both",start_iru(r)}},{label:"Cancel",callback:function(){o=!1}}])})});$("#resultList").blur(),$("#resultList").chosen(),$("#barcodes tr").click(function(){var e=$(this).find("td:first").text().trim()}),$("#CA_barcodes tr").click(function(){var e=$(this).find("td:first").text().trim()}),$.colorbox.close=function(){location.reload()},$("#close_progress").click(function(){$("#backdrop_progress, #progress").remove(),clearInterval($(document).data("report_progress"))});var t=$("#q30_quality").data("percent");$("#q30_quality").strength(t,"undefined",t,"Sequence >= Q30"),$("#plugin-modal").modal({backdrop:!0,show:!1}),$("#resultList").change(function(){window.location="/report/"+$(this).val()}),$("#review_plan").click(function(e){e.preventDefault(),$("#error-messages").hide().empty();var t=$(this).attr("href");$("body #modal_review_plan").remove(),$.get(t,function(e){return $("body").append(e),$("#modal_review_plan").modal("show"),!1}).done(function(e){}).fail(function(e){$("#error-messages").empty().show(),$("#error-messages").append('<p class="alert error">ERROR: '+e.responseText+"</p>")}).always(function(e){})}),$("#copy_plan").click(function(e){$("body").css("cursor","wait"),e.preventDefault(),$("#error-messages").hide().empty();var t='<div class="myBusyDiv"><div class="k-loading-mask" style="width:100%;height:100%"><span class="k-loading-text">Loading...</span><div class="k-loading-image"><div class="k-loading-color"></div></div></div></div>';$("body").prepend(t),pk=$(this).data("pk"),url="/plan/planned/"+pk+"/copy/",$("body #modal_plan_wizard").remove(),$("body #modal_plan_run").remove(),$.get(url,function(e){return $("body").append(e),setTab("#ws-1"),$("#modal_plan_wizard").modal("show"),!1}).done(function(e){console.log("success:",url)}).fail(function(e){$("body").css("cursor","default"),$(".myBusyDiv").empty(),$("body").remove(".myBusyDiv"),$("#error-messages").empty().show(),$("#error-messages").append('<p class="error">ERROR: '+e.responseText+"</p>"),console.log("error:",e)}).always(function(e){$("body").css("cursor","default"),$(".myBusyDiv").empty(),$("body").remove(".myBusyDiv"),delete t})}),$("#dm_actions").click(function(e){return e.preventDefault(),$("body #modal_dm_actions").remove(),$.get($(this).attr("href"),function(e){$("body").append(e),$("#modal_dm_actions").modal("show")}),!1}),pluginStatusLoad(),$(".pluginRemove").live("click",function(e){e.preventDefault();var t=$(this).attr("href"),n=$(this).closest("div.pluginGroup");return $.ajax({type:"DELETE",url:t,async:!0,beforeSend:function(){n.animate({backgroundColor:"#fb6c6c"},300)}}).fail(function(e){n.append('<div class=" alert alert-error" data-dismiss="alert">Failed to remove plugin result.</div>')}).done(function(){n.append('<div class="alert alert-info" data-dismiss="alert">Successfully removed plugin result.</div>'),n.fadeOut(3e3,function(){n.remove()})}),!1}),$(".pluginLog").live("click",function(e){e.preventDefault();var t=$(this).attr("href"),n=$($(this)).data("title"),r=$($(this).parent());r.activity({segments:10,width:3,space:2,length:2.5,color:"#252525",speed:1.5,padding:"3"});var i=$("#modal_plugin_log");return i.find(".modal-body").html(""),i.find(".modal-header h3").text(n),$.get(t,function(e){i.find(".modal-body").html('<pre class="log">'+htmlEscape(e)+"</pre>")}).fail(function(e){i.find(".modal-body").html('<div class="log alert alert-error">Unable to read plugin log:'+htmlEscape(e.statusText)+"</div>")}).always(function(){r.activity(!1),i.modal("show")}),!1}),$(".pluginCancel").live("click",function(e){e.preventDefault();var t=$(this).data("id"),n=$(this).data("jobid");$.post("/rundb/api/v1/pluginresult/"+t+"/control/",function(){$("pluginStatusLoad").append('<div class="alert alert-info" data-dismiss="alert">Plugin Job '+n+" is being terminated via SGE</div>")},"json").fail(function(e){$("pluginStatusLoad").append('<div class="alert alert-error" data-dismiss="alert">Failed to terminate SGE Job '+n+"</div>")}).always(function(){setTimeout(pluginStatusLoad,3e3)})}),$("#pluginRefresh").click(function(){pluginStatusLoad()}),$("#pluginExpandAll").click(function(){$("#pluginStatusTable .plugin-collapse").text("-"),$("#pluginStatusTable .pluginGroupList").slideDown("fast");var e={};for(var t=0;t<table_plugin_names.length;t++)e[table_plugin_names[t]]=!0;update_plugin_show(e)}),$("#pluginCollapseAll").click(function(){$("#pluginStatusTable .plugin-collapse").text("+"),$("#pluginStatusTable .pluginGroupList").slideUp("fast");var e={};for(var t=0;t<table_plugin_names.length;t++)e[table_plugin_names[t]]=!1;update_plugin_show(e)}),$("#pluginDialogButton").click(function(){$("#modal-header").html("Select a plugin"),$("#modal-body").html("<div id='pluginLoad'></div><div id='pluginList'></div>"),$("#pluginLoad").html("<span>Loading Plugin List <img src='/site_media/jquery/colorbox/images/loading.gif'></img></span>"),$("#plugin-modal").modal("show"),$.ajax({url:"/rundb/api/v1/plugin/?selected=true&limit=0&order_by=name",dataType:"json",type:"GET",async:!1,success:function(e){var t=[];if(e.objects.length===0)return $("#pluginLoad").html(""),$("#pluginList").html('<p>No plugins enabled. Go to <a href="/configure/plugins/">Configure:Plugins</a> to install and enable plugins.</p>'),!1;$("#pluginList").html('<table id="plugin_table" class="table table-striped"></table>'),plugins=e.objects.sort(function(e,t){return e.name.toLowerCase()>t.name.toLowerCase()?1:-1});for(var n=0;n<plugins.length;n++)val=plugins[n],val.isInstance?$("#plugin_table").append('<tr><td><a href="'+val.input+"?report="+djangoPK+'" class="plugin_input_class plugin_link colorinput" data-id="'+val.id+'" id="'+val.name+'_plugin">'+val.name+"</a> <small>&#8212; v"+val.version+"</small></td></tr>"):$("#plugin_table").append('<tr><td><a href="#PluginOutput" class="plugin_class" data-id="'+val.id+'" id="'+val.name+'_plugin">'+val.name+"</a> <small>&#8212; v"+val.version+"</small></td></tr>");$("#pluginLoad").html("")}}),$(".plugin_link").colorbox({width:"90%",height:"90%",iframe:!0}),$(".plugin_input_class").die("click"),$(".plugin_input_class").live("click",function(){$("#plugin-modal").modal("hide")}),$(".plugin_class").die("click"),$(".plugin_class").live("click",function(){var e=$(this).data("id"),t=$(this).attr("id");t=t.substring(0,t.length-7),pluginAPIJSON={plugin:{id:e,name:t},pluginconfig:{}},pluginAPIJSON=JSON.stringify(pluginAPIJSON),$.ajax({type:"POST",url:pluginURL,async:!0,contentType:"application/json; charset=utf-8",data:pluginAPIJSON,dataType:"json",processData:!1,beforeSend:function(){$("#pluginList").html(""),$("#pluginLoad").html("<span>Launching Plugin "+t+" <img src='/site_media/jquery/colorbox/images/loading.gif'></img></span>")},success:function(){$("#plugin-modal").modal("hide"),pluginStatusLoad()},failure:function(){$("#pluginLoad").html("<span>ERROR: Failed to launch Plugin "+t+"</span>")}})})}),$.QueryString.no_header?($(".tab-pane").each(function(){$(this).removeClass("tab-pane"),$(this).addClass("tabBox"),$(this).prepend("<h2>"+$(this).data("title")+"</h2><hr/>")}),$(".nav,.sub-nav,.page-nav,.btn, #resultSet,.footer,#resultSet,#OutputFiles").hide(),$(".main-push").remove(),$(".main").css({background:"-webkit-gradient(linear, 0% 0%, 100% 100%, from(#ffffff), to(#ffffff))"}),$(".header").hide(),$("#nameRow").removeClass("span6").addClass("span12"),$("#beadfind, #basecaller, #readlength").removeClass("span3").addClass("span4"),$("#alignMap, #rawAligned").removeClass("span3").addClass("span6"),$(".tabBox").css({border:"3px black solid",margin:"20px"}),$(".pluginGroup").css({border:"1px black solid",margin:"10px"}),$(".unaligned .well").css("min-height","390px"),$(".aligned .well").css({"min-height":"370px",height:"370px"}),$(".content").css({"box-shadow":"0px 0px","border-radius":"0px",border:"0px"})):(resizeIntervalTimer=setInterval(function(){resizeiFrames()},1e3),typeof CA_barcodes_json!="undefined"&&$("#CA_barcodes").kendoGrid({dataSource:{data:CA_barcodes_json,schema:{model:{fields:{ID:{type:"string"},Filtered_Mapped_Bases_in_Q7_Alignments:{type:"integer"},Total_number_of_Reads:{type:"integer"},Filtered_Q7_Mean_Alignment_Length:{type:"integer"}}}},pageSize:10},height:"auto",groupable:!1,scrollable:!1,selectable:!1,sortable:{mode:"multiple",allowUnsort:!0},pageable:{pageSizes:[5,10,20,50,100,1e3]},columns:[{field:"ID",title:"Barcode Name"},{field:"Filtered_Mapped_Bases_in_Q7_Alignments",title:"Aligned Output"},{field:"Total_number_of_Reads",title:"Reads"},{field:"Filtered_Q7_Mean_Alignment_Length",title:"Mean Aligned Read Length"},{title:"BAM",sortable:!1}],rowTemplate:kendo.template($("#CA_barcodesRowTemplate").html())}),typeof barcodes_json!="undefined"&&$("#barcodes").kendoGrid({dataSource:{data:barcodes_json,schema:{model:{fields:{barcode_name:{type:"string"},sample:{type:"string"},total_bases:{type:"integer"},Q20_bases:{type:"integer"},read_count:{type:"integer"},mean_read_length:{type:"string"},filtered:{type:"boolean"},file_prefix:{type:"string"},bam_link:{type:"string"},bai_link:{type:"string"},basecaller_bam_link:{type:"string"}}}},pageSize:10},height:"auto",groupable:!1,scrollable:!1,selectable:!1,sortable:{mode:"multiple",allowUnsort:!0},pageable:{pageSizes:[5,10,20,50,100,1e3]},columns:[{field:"barcode_name",title:"Barcode Name"},{field:"sample",title:"Sample"},{field:"total_bases",title:"Bases"},{field:"Q20_bases",title:">=Q20 Bases"},{field:"read_count",title:"Reads"},{field:"mean_read_length",title:"Mean Read Length"},{title:"Read Length Histogram",sortable:!1},{title:"BAM",sortable:!1}],rowTemplate:kendo.template($("#barcodesRowTemplate").html())}),$("#file_table").kendoGrid({dataSource:{pageSize:10},height:"auto",groupable:!1,scrollable:!1,selectable:!1,sortable:!1,pageable:!1}),$("#test_fragments").kendoGrid({dataSource:{pageSize:10},height:"auto",groupable:!1,scrollable:!1,selectable:!1,sortable:!1,pageable:!0}))});