{% extends "rundb/plan/page_plan/base.html" %}
{% load url from future %}

{% block main-title %}Select the sequencing kits and then hit next.{% endblock main-title %}

{% block page-plan-content %}
<div class="row-fluid">
    <div class="span6">
        <input type="hidden" id="isBarcodeKitRequired" name="isBarcodeKitRequired" value="" />

        <label class="form-label">Sample Preparation Kit (optional)</label>
        <select id="samplePreparationKit" name="samplePreparationKit" style="width: 350px;" {% if not helper.getApplProduct.isSamplePrepKitSupported %} disabled="disabled" {% endif %}>
            <option value=""></option>
            {% for spk in step.getPrePopulatedFieldDict.samplePrepKits %}
                {% ifequal spk.name step.getCurrentSavedFieldDict.samplePreparationKit %}
                    <option SELECTED value="{{spk.name}}">{{spk.description}}</option>
                {% else %}
                    <option value="{{spk.name}}">{{spk.description}}</option>
                {% endifequal %}
            {% endfor %}
        </select>
    </div>
    <div class="span6">
        <label class="form-label">Control Sequence (optional)</label>
        <select id="controlsequence" name="controlsequence">
            <option value=""></option>
            {% for kit in step.getPrePopulatedFieldDict.controlSeqKits %}
                {% ifequal kit.name step.getCurrentSavedFieldDict.controlsequence %}
                    <option SELECTED value="{{kit.name}}">{{kit.description}}</option>
                {% else %}
                    <option value="{{kit.name}}">{{kit.description}}</option>
                {% endifequal %}
            {% endfor %}
        </select>
    </div>
</div>
<div class="row-fluid">
    <div class="span6">
        <label class="form-label">Library Kit Type  <a class="btn btn-mini extra-kit-inline">Details +</a></label>
        <select id="libraryKitType" name="librarykitname" style="width: 350px;">
            <option value=""></option>
            {% for libKit in step.getPrePopulatedFieldDict.libKits %}
                {% ifequal libKit.name step.getCurrentSavedFieldDict.librarykitname %}
                    <option SELECTED value="{{libKit.name}}">{{libKit.description}}</option>
                {% else %}
                    <option value="{{libKit.name}}">{{libKit.description}}</option>
                {% endifequal %}
            {% endfor %}
        </select>
    </div>
    <div class="span6">                                     
        <label class="form-label">Chip Type{%if step.prepopulatedFields.is_chipType_required%} (required){%endif%}</label>
        <select id="chipType" name="chipType">
            {% if helper.isEditRun %}
                <option SELECTED value="{{step.getCurrentSavedFieldDict.chipType}}">Ion 
                {% if step.getPrePopulatedFieldDict.chipTypes %}
                    {% with step.getPrePopulatedFieldDict.chipTypes.0 as chipType %}
                        {{chipType.getChipDisplayedNamePrimaryPrefix}}&trade;{{chipType.getChipDisplayedNameSecondaryPrefix}} Chip {{chipType.getChipDisplayedVersion}}
                    {% endwith %}
                {% else %}
                    {{step.getCurrentSavedFieldDict.chipType.getChipDisplayedNamePrefix}}&trade; Chip {{chipType.getChipDisplayedVersion}}
                {% endif %}
                </option>
            {% else %}
                <option value=""></option>
                {% for chipType in step.getPrePopulatedFieldDict.chipTypes %}
                    {% if chipType.name == step.getCurrentSavedFieldDict.chipType %}
                        <option SELECTED 
                    {% elif not helper.isTemplate and chipType.name == helper.getStepDict.Application.savedObjects.applProduct.defaultChipType %}
                        <option SELECTED 
                    {% else %}                    
                        <option 
                    {% endif %}
                    value="{{chipType.name}}">Ion {{chipType.getChipDisplayedNamePrimaryPrefix}}&trade;{{chipType.getChipDisplayedNameSecondaryPrefix}} Chip {{chipType.getChipDisplayedVersion}}</option>
                {% endfor %}
            {% endif %}
        </select>
    </div>
</div>                  
<div class="extra_kit_forward_info row-fluid hide" style="display: block;">
    <div class="span6">
        <label>Forward Library Key:</label>
        <select id="libraryKey" name="libraryKey" value="" class="select-group"  style="width:350px;">
            <option value=""></option>
            {% for libKey in step.getPrePopulatedFieldDict.forwardLibKeys %}
                {% ifequal libKey.sequence step.getCurrentSavedFieldDict.libraryKey %}
                    <option SELECTED value="{{libKey.sequence}}">{{libKey}}</option>
                {% else %}
                    <option value="{{libKey.sequence}}">{{libKey}}</option>
                {% endifequal %}
            {% endfor %}
        </select>
        <label>Test Fragment Key:</label>
        <input type="text" name="tfKey" value={{step.getCurrentSavedFieldDict.tfKey}}
               onkeyup="if('atcgATCG'.indexOf(this.value.slice(-1))<0) alert('Invalid TF key character');">
    </div>
    <div class="span6">                                     
        <label>Forward 3' Adapter:</label>
        <select id="forward3primeAdapter" name="forward3primeAdapter" value="" class="select-group">
            <option value=""></option>
            {% for adapter in step.getPrePopulatedFieldDict.forward3Adapters %}
                {% ifequal adapter.sequence step.getCurrentSavedFieldDict.forward3primeAdapter %}
                    <option SELECTED value="{{adapter.sequence}}">{{adapter}}</option>
                {% else %}
                    <option value="{{adapter.sequence}}">{{adapter}}</option>
                {% endifequal %}
            {% endfor %}
        </select>
    </div>
</div>                      
<div class="row-fluid">
    <div class="span6">
        <p class="form-label">Template Kit
        <span class="option-group">
        <small style="font-weight: normal; font-size: 75%;">
            {% for kitTypeName, kitDict in step.getPrePopulatedFieldDict.templateKitTypes.items %}
                {% ifequal kitTypeName "Avalanche" %}
                {% else %}
                <input type="radio" id="{{kitTypeName}}__templatekitType" name="templatekitType" value="{{kitTypeName}}"
                    {% ifequal kitTypeName step.getCurrentSavedFieldDict.templatekitType %}
                        checked="checked" data-templatekitname="{{step.getCurrentSavedFieldDict.templatekitname}}"
                    {% endifequal %}
                >{{kitTypeName}}
                {% endifequal %}
            {% endfor %}
        </p>      
        </small>
        </span>
        
        <div id="templateKitHolder">
            {% if not step.getCurrentSavedFieldDict.templatekitType %}
                <input id="templateKit_comment" name="templateKit_comment" type="text" placeholder="Choose instrument to view Template Kit menu" style="width: 335px" disabled>
            {% endif %}
            
            <select id="templateKit" name="templatekitname" style="width: 350px;" {% if not step.getCurrentSavedFieldDict.templatekitType %} class="hide" {% endif %}>
                <option value=""></option>
                {% for kitTypeName, kitDict in step.getPrePopulatedFieldDict.templateKitTypes.items %}
                    {% for kit in kitDict.kit_values %}
                        <option value="{{kit.name}}" class="{{kitTypeName}}"
                            {% if kitTypeName != step.getCurrentSavedFieldDict.templatekitType %}
                                style="display: none;"
                            {% elif kit.name == step.getCurrentSavedFieldDict.templatekitname %}
                                SELECTED
                            {% elif kit.name == kitDict.applDefault.name and not step.getCurrentSavedFieldDict.templatekitname %}
                                SELECTED
                            {% endif %}
                                >{{kit.description}}</option>
                    {% endfor %}
                {% endfor %}
            </select>
            
        </div>
    </div>

    <div class="span6">                                     
        <label class="form-label" id="barcodeKitLabel">Barcode Set {% if helper.getApplProduct.isBarcodeKitSelectionRequired %}(required){% else %}(optional){% endif %}</label>
        <select id="barcodeId" name="barcodeId" {% if helper.isPlanBySample and step.getCurrentSavedFieldDict.barcodeId %}disabled="disabled"{% endif %}>
            <option value=""></option>
            {% for kit in step.getPrePopulatedFieldDict.barcodes %}
                {% ifequal kit.name step.getCurrentSavedFieldDict.barcodeId %}
                    <option SELECTED value="{{kit.name}}">{{kit.name}}</option>
                {% else %}
                    <option value="{{kit.name}}">{{kit.name}}</option>
                {% endifequal %}
            {% endfor %}
        </select>
    </div>
</div>

<div class="templating_size_info row-fluid hide" style="display: block;">
    <div class="span6">
        <p style="font-weight: bold; font-size: 14px; margin-bottom: 8px;">Templating Size:
        <span class="option-group">
            <small style="font-weight: normal; font-size: 100%;">
                {% for size in step.getPrePopulatedFieldDict.templatingSizeChoices %}
                    <label style="display: inline;">
                        <input type="radio" id="templatingSize_{{size}}" name="templatingSize" value="{{size}}" {% if helper.isEditRun %} readonly {% endif %}
                            {% ifequal size step.getCurrentSavedFieldDict.templatingSize %} checked="checked" {% endifequal %}\>{{size}}
                    </label>
                {% endfor %}
            </small>
        </span>
        </p>
    </div>
    <div class="span6">
    </div>
</div>        

<div class="library_read_length_info row-fluid hide" style="display: block;">
    <div class="span6">
        <p style="font-weight: bold; font-size: 14px; margin-bottom: 12px;">Library Read Length:
        <input value="{{step.getCurrentSavedFieldDict.libraryReadLength}}" style="width:50px; font-weight: normal; font-size: 14px;" name="libraryReadLength" id="libraryReadLength" {% if helper.isEditRun %} readonly {% endif %}>
        </p>
    </div>
    <div class="span6">
    </div>
</div>

<div class="row-fluid">
    <div class="span6">
        <label class="form-label" >Sequencing Kit</label>
        <select id="sequenceKit" name="sequencekitname" style="width: 350px;">
            <option value=""></option>
            {% for kit in step.getPrePopulatedFieldDict.seqKits %}
                {% ifequal kit.name step.getCurrentSavedFieldDict.sequencekitname %}
                    <option SELECTED value="{{kit.name}}">{{kit.description}}</option>
                {% else %}
                    <option value="{{kit.name}}">{{kit.description}}</option>
                {% endifequal %}
            {% endfor %}
        </select>
    </div>
    <div class="span6">
        <p class="form-label" rel="tooltip" title="PCR duplicates will be flagged in the BAM file"><i class="icon-info-sign"></i> Mark as Duplicates Reads 
            <input type="checkbox" id="isDuplicateReads" name="isDuplicateReads" 
                {% if step.getCurrentSavedFieldDict.isDuplicateReads %}checked="checked"{% endif %} style="vertical-align:top;">
            
        </p>
        <p class="form-label" rel="tooltip" title="Base Calibration allows for empirical alignments to influence flow signals to achieve better homopolymer calibration to improve overall accuracy">
        <i class="icon-info-sign"></i> Base Calibration Mode</p>
        <select id="base_recalibrate" name="base_recalibrate" style="width: 220px;">
        <!--option value=""></option -->

        {% for mode, displayedMode in step.getPrePopulatedFieldDict.base_recalibration_modes.items %}
            {% ifequal mode step.getCurrentSavedFieldDict.base_recalibrate %}
                <option SELECTED value="{{mode}}">{{displayedMode}}</option>
            {% else %}
                <option value="{{mode}}">{{displayedMode}}</option>
            {% endifequal %}
        {% endfor %}
        </select>
        
        <p class="form-label" rel="tooltip" title="Optional analysis step to adjust the alignment, primarily in the CIGAR string"><i class="icon-info-sign"></i> Enable Realignment
            <input type="checkbox" id="realign" name="realign" {% if step.getCurrentSavedFieldDict.realign %}checked="checked"{% endif %} style="vertical-align:top;">           
        </p>
    </div>
</div>
<div class="row-fluid">
    <div class="span6">
        <p style="font-weight: bold; font-size: 14px; margin-bottom: 8px;">Flows:
        <input value="{{step.getCurrentSavedFieldDict.flows}}" style="width:50px; font-weight: normal; font-size: 14px;" name="flows" id="flows" {% if helper.isEditRun %} readonly {% endif %}>
        </p>
    </div>
    <div class="span6">
    </div>
</div>

<div class="row-fluid">
    {% for key, value in step.validationErrors.items %}
        <h4 style="color: red">{{value}}</h4>
    {% endfor %}
</div>
{% endblock page-plan-content %}

{% block prevnext-buttons %}
    <a class="btn btn-100" href="#" onclick="$('#step_form').attr('action', '{% url "page_plan_application" %}');$('#step_form').submit();return false;">&larr; Previous</a>
    <a class="btn btn-primary btn-100 pull-right" href="#" onclick="$('#step_form').attr('action', '{% url "page_plan_plugins" %}');$('#step_form').submit();return false;">Next &rarr;</a>
    
{% endblock prevnext-buttons %}

{% block summary-table %}
    {%include "rundb/plan/page_plan/summary/kit_summary.html"%}
{% endblock summary-table %}

{% block post-raw %}
{{ block.super }}
<script type="text/javascript">

    $(document).ready(function () {

        $("form").submit(function(){
            $("select[name=barcodeId]").attr('disabled', false);
        });

        $("#base_recalibrate").each( function (){
            var i =0;
            var sel = this;
            for(i = 0; i < sel.length;i++){
                if (sel.options[i].text == "Default Calibration") {
                    sel.options[i].title = "A random sample of reads (up to 100,000 by default) is aligned and used to determine calibration parameters, which are then applied to the rest of the run";
                }
                else if (sel.options[i].text == "Enable Calibration Standard") {
                    sel.options[i].title = "Select Enable Calibration Standard when the experiment does not include a reference BAM file.  Only choose this option if you have added Calibration Standards with the library for AmpMix preparation.";
                }
            }
           } 
        );
        
        var _isEditRun = "{{helper.isEditRun}}" == "True" ? true : false;
        
        var seq_kits_to_flows_map = {};
        var seq_kits_to_categories_map = {};

        {%for kitinfoobj in step.getPrePopulatedFieldDict.seqKits %}
            seq_kits_to_flows_map["{{kitinfoobj.name}}"] = "{{kitinfoobj.flowCount}}";
            seq_kits_to_categories_map["{{kitinfoobj.name}}"] = "{{kitinfoobj.categories}}";
        {%endfor%}

        var template_kits_to_flows_map = {};
        var template_kits_to_readLengths_map = {};
        var template_kits_to_templatingSize_map = {};
        var template_kits_to_categories_map = {};

        {% for templateKitInfoObj in step.getPrePopulatedFieldDict.templateKits %}
            template_kits_to_flows_map["{{templateKitInfoObj.name}}"] = "{{templateKitInfoObj.flowCount}}";
            template_kits_to_readLengths_map["{{templateKitInfoObj.name}}"] = "{{templateKitInfoObj.libraryReadLength}}";
            template_kits_to_templatingSize_map["{{templateKitInfoObj.name}}"] = "{{templateKitInfoObj.templatingSize}}";
            template_kits_to_categories_map["{{templateKitInfoObj.name}}"] = "{{templateKitInfoObj.categories}}";
        {%endfor%}

        var lib_kits_to_categories_map = {};

        {%for kitinfoobj in step.getPrePopulatedFieldDict.libKits %}
            lib_kits_to_categories_map["{{kitinfoobj.name}}"] = "{{kitinfoobj.categories}}";
        {%endfor%}        
        
        var barcode_kits_subset_list = [];
        
        {% for barcodeKit in step.getPrePopulatedFieldDict.barcodes_subset %}
            barcode_kits_subset_list.push("{{barcodeKit.name}}");
        {% endfor %}
        
        var barcode_kits_all_list = [];
        
        {% for barcodeKit in step.getPrePopulatedFieldDict.barcodes %}
            barcode_kits_all_list.push("{{barcodeKit.name}}");
        {% endfor %}
        

        function handleTemplateKitSelectionForTemplatingSize(selectedTemplateKitName) {
            $('input[name = "templatingSize"]').prop('checked', false);                    
            $('.templating_size_info').hide();
            
            var defaultTemplatingSize = "";
            
            if (selectedTemplateKitName) {
                var categories = template_kits_to_categories_map[selectedTemplateKitName] || '';

                if (categories.toLowerCase().indexOf("multipletemplatingsize") >= 0) {
                    var allowed_templatingSizes = template_kits_to_templatingSize_map[selectedTemplateKitName];
                    //console.log("at handleTemplateKitSelectionForTemplatingSize() categories=", categories, "; allowed_templatingSizes=", allowed_templatingSizes);
                    if (allowed_templatingSizes) {
                        $('input[name = "templatingSize"]').parent().hide();

                        jQuery.each(allowed_templatingSizes.split(";"), function(index, item) {
                            $('input[name = "templatingSize"][value="' + item + '"]').parent().show();
                            if (index == 0) {
                                $('input[name = "templatingSize"][value="' + item + '"]').prop('checked', true);
                                defaultTemplatingSize = item;
                            }
                        });
                        $('.templating_size_info').show(); 
                    }
                }
            }
            updateSummaryPanel("#selectedTemplatingSize", defaultTemplatingSize);
        }

        function handleTemplateKitSelectionForLibraryReadLength(selectedTemplateKitName) {
            $('.library_read_length_info').hide();

            var defaultLibraryReadLength = 0;
            
            if (selectedTemplateKitName) {
                defaultLibraryReadLength = template_kits_to_readLengths_map[selectedTemplateKitName];
                $('input[name = "libraryReadLength"]').val(defaultLibraryReadLength);

                if (defaultLibraryReadLength > 0) {
                    var categories = template_kits_to_categories_map[selectedTemplateKitName] || '';
    
                    if (categories.toLowerCase().indexOf("supportlibraryreadlength") >= 0) {
                        $('.library_read_length_info').show();
                        setFlowCountByLibraryReadLength(defaultLibraryReadLength);
                    }
                }
            }
            updateSummaryPanel("#selectedLibraryReadLength", defaultLibraryReadLength);
        }
        

        function handleSeqKitSelectionForLibraryReadLength(selectedSeqKitName) {
            
            var templateKit = $("select[name='templatekitname']").val()
            if (templateKit) {
                var categories = template_kits_to_categories_map[templateKit] || '';
                
                if (categories.toLowerCase().indexOf("supportlibraryreadlength") >= 0) {
                    setLibraryReadLengthByFlowCount();
                }
            }
        }

        function setLibraryReadLengthByFlowCount() {
            var sequenceKit = $("select[name='sequencekitname']").val();
            
            if (sequenceKit) {
                var categories = seq_kits_to_categories_map[sequenceKit] || '';
                if (categories.toLowerCase().indexOf("readlengthderivablefromflows") >= 0){
                    var seqKitFlowCount = seq_kits_to_flows_map[sequenceKit];
                    
                    $('input[name = "libraryReadLength"]').val(seqKitFlowCount / 2);
                    updateSummaryPanel("#selectedLibraryReadLength", seqKitFlowCount / 2);
                }
            }
        }
        

        function updateSummaryPanel(el, value){
            if (typeof value == 'undefined') value = '';
            if (el=="#selectedLibraryReadLength" && value<=0) value = "--";
            $(el).text(value);
        }
        
        
        function updateFlows(value) {
            if (!_isEditRun && value > 0){
                $('input[name = "flows"]').val(value);
                updateSummaryPanel("#selectedFlows", value);
            }
        }
        
        function setFlowCountBySelectedKits(){
            
            if (_isEditRun) return;
            
            var templateKit = $("#templateKit :selected").val();
            var sequenceKit = $("#sequenceKit :selected").val();
            var templateKitFlowCount = template_kits_to_flows_map[templateKit];
            var sequenceKitFlowCount = seq_kits_to_flows_map[sequenceKit];

            var flowCount = 0;
            if (!templateKit){
                flowCount = sequenceKitFlowCount;
            } else if (!sequenceKit){
                flowCount = templateKitFlowCount;
            } else {
                // both kits selected: use templateKit flows if flowoverridable, otherwise use sequenceKit flows
                var categories = seq_kits_to_categories_map[sequenceKit] || '';
                if ((categories.toLowerCase().indexOf("flowoverridable") >= 0) && (templateKitFlowCount > 0)){
                    flowCount = templateKitFlowCount;
                } else {
                    flowCount = sequenceKitFlowCount;
                }
            }
            updateFlows(flowCount);
        }
        
        function setFlowCountByLibraryReadLength(libraryReadLength) {
            var sequenceKit = $("#sequenceKit :selected").val();
            if (sequenceKit) {
                var categories = seq_kits_to_categories_map[sequenceKit] || '';
                if (categories.toLowerCase().indexOf("flowsderivablefromreadlength") >= 0){
                    updateFlows(libraryReadLength * 2);
                }
            }
        }

        function  set_barcodeKit_to_select(value_list) {
            var $selects = $("#barcodeId");
            $selects.empty();
            $selects.append($("<option></option>"));
            
            //loop through the barcode kits
            $.each(value_list, function(i) {
                var value = value_list[i];
                
                var $opt = $("<option></option>");
                if (value == "{{step.getCurrentSavedFieldDict.barcodeId}}") {
                    $opt.attr("selected","selected");
                }                
                $opt.attr('value', value);
                $opt.text(value);
                $selects.append($opt);
            });
                
        }        

        $("#sequenceKit").on('change', function(){
            if (!_isEditRun) {
                var selectedSequenceKitName = $(this).val();
    
                setFlowCountBySelectedKits()
                handleSeqKitSelectionForLibraryReadLength(selectedSequenceKitName);
            }

            updateSummaryPanel("#selectedSequenceKit", seqKitNameToDesc[selectedSequenceKitName]);
        });

        $("#samplePreparationKit").change(function()  {
            updateSummaryPanel("#selectedSamplePreparationKit", $(this).val());
        });


        $("#libraryKitType").change(function()  {
        	//update barcode kit selection list on library kit selection changed
        	var libKitName = $(this).val();
        	//console.log("at libraryKitType.change() libKitName=", libKitName);
        	
            $('#barcodeKitLabel').text("Barcode Set (optional)");
            $('input[name = "isBarcodeKitRequired"]').val("false");
            
        	if (libKitName) {
            	var categories = lib_kits_to_categories_map[libKitName] || '';
                
                if (categories.toLowerCase().indexOf("bcrequired") >= 0) {
                    $('#barcodeKitLabel').text("Barcode Set (required)");
                    $('input[name = "isBarcodeKitRequired"]').val("true");
                }
                
                if (categories.toLowerCase().indexOf("bcshowsubset") >= 0) {
                    set_barcodeKit_to_select(barcode_kits_subset_list);
                } else {
                    set_barcodeKit_to_select(barcode_kits_all_list);
                }
            }
            else {
                set_barcodeKit_to_select(barcode_kits_all_list);
            }
            
            updateSummaryPanel("#selectedLibraryKitType", libKitNameToDesc[libKitName]);
        }).change();


        $('input[name="templatekitType"]').change(function () {

            $("#templateKit_comment").hide();
            $("#templateKit").show();
                
            // show/hide templateKit select options based on type
            var templateType = $(this).val();
            var $options = $("#templateKit option");
            $options.not(':first').hide();
            $options.filter("."+templateType).show();
            
            // retrieve previously selected kit or default if any
            var templateKit = $(this).data('templatekitname');
            if (!templateKit){
                if (templateType == 'OneTouch') {
                    templateKit = "{{helper.getStepDict.Application.savedObjects.applProduct.defaultTemplateKit.name}}";
                } else if (templateType == 'IonChef') {
                    templateKit = "{{helper.getStepDict.Application.savedObjects.applProduct.defaultIonChefPrepKit.name}}";
                } else {
                    templateKit = '';
                }
            }

            $("#templateKit").val(templateKit).change();
        });


        $("#templateKit").change(function()  {

        	var selectedVal = $(this).find("option:selected").val();
        	
            // save kit value to restore if type selection changes
            $('input[name="templatekitType"]:checked').data('templatekitname', selectedVal);
            
            setFlowCountBySelectedKits();
        	handleTemplateKitSelectionForTemplatingSize(selectedVal)
        	handleTemplateKitSelectionForLibraryReadLength(selectedVal);
        	
            updateSummaryPanel("#selectedTemplatingKitName", templateKitNameToDesc[selectedVal]);
        });


        $("#libraryKey").change(function() {
            updateSummaryPanel("#selectedLibraryKey", libraryKeySeqToNameAndSeq[$(this).val()]);
        });
        

        $("#forward3primeAdapter").change(function() {
        	var value = $(this).val();

            if (value == "{{step.getCurrentSavedFieldDict.avalancheForward3PrimeAdapter}}") {
            	$('input[name="templatekitType"][value="OneTouch"]').attr('checked', true).change();
            }
            
            updateSummaryPanel("#selected3PrimeAdapter", threePrimeAdapterSeqToNameAndSeq[value]);
        });


        var flowsSpinner = $("#flows").spinner({min: 1, max: 2000});
        flowsSpinner.spinner("value", '{{step.getCurrentSavedFieldDict.flows}}');
        if (_isEditRun){
            flowsSpinner.spinner("disable").prop('disabled',false);
        } else {
            $("#flows").on("spinstop spinchange", function(event, ui){
                updateSummaryPanel("#selectedFlows", flowsSpinner.spinner("value"));
            });
        }

    
        var readLengthSpinner = $("#libraryReadLength").spinner({min: 0, max: 1000});
        readLengthSpinner.spinner("value", '{{step.getCurrentSavedFieldDict.libraryReadLength}}');
        if (_isEditRun){
            readLengthSpinner.spinner("disable").prop('disabled',false);
        } else {
            $("#libraryReadLength").on("spinstop spinchange", function(event, ui){
                var value = readLengthSpinner.spinner("value");
                updateSummaryPanel("#selectedLibraryReadLength", value); 
                setFlowCountByLibraryReadLength(value);
            });
        }


        $('input[type=radio][name=templatingSize]').change(function() {
            updateSummaryPanel("#selectedTemplatingSize", this.value);

            // TS-10547 set number of flows based on templating size selection
            var templating_size_to_flows_map = {'200':'500', '400':'850'};
            var flowCount = templating_size_to_flows_map[this.value];
            updateFlows(flowCount);
        });
        
        $("#controlsequence").change(function()  {
            updateSummaryPanel("#selectedControlSequence", $(this).val());
        });     

        $("#chipType").change(function()  {
            updateSummaryPanel("#selectedChipType", chipNameToDisplayName[$(this).val()]);
        });     
        
        $("#barcodeId").change(function()  {
            updateSummaryPanel("#selectedBarcode", $(this).val());
        });
        
        $(".extra_kit_forward_info").hide();
        $(".extra-kit-inline").click(function() {
            if (($(".extra_kit_forward_info").is(":visible"))) {
                $(".extra-kit-inline").text("Details +");
                $(".extra_kit_forward_info").hide();
            } else {
                $(".extra-kit-inline").text("Details -");
                $(".extra_kit_forward_info").show();
            }
        });
        
        //hide libraryReadLength UI section by default if value is zero
        if ($('input[name = "libraryReadLength"]').val() > 0) {
            $(".library_read_length_info").show();
        }
        else {
            $(".library_read_length_info").hide();
        }

        //hide templatingSize UI section by default if value is blank
        if ($('input[name = "templatingSize"]:checked').val() == undefined) {
            $(".templating_size_info").hide();
        }
        else {
            $(".templating_size_info").show();
        }

        $('#isDuplicateReads').change(function(){
            if($(this).is(':checked')) {
                $('#selectedMarkAsPcrDuplicates').text('True');
            } else {
                $('#selectedMarkAsPcrDuplicates').text('False');
            }
            
        });
    });
</script>
{% endblock post-raw %}
