{%extends "rundb/plan/page_plan/base.html"%}
{% block extra_head %}
{{ block.super }}
{% load static %}
<script src="{% static "jquery/js/apprise/apprise-1.5.min.js"%}"></script>
    <link rel="stylesheet" type="text/css"
        href="{% static "jquery/colorbox/colorbox.css"%}" media="screen"/>
    <link rel="stylesheet" href="{% static "jquery/js/apprise/apprise.css"%}"
        type="text/css"/>
<script type="text/javascript" src="/site_media/resources/scripts/plan/iru_validation.js"></script>
<script type="text/javascript" src="/site_media/js/jquery.blockUI.js"></script>
<style>
.darkClass
{
    background-color: white;
    filter:alpha(opacity=30); /* IE */
    opacity: 0.3; /* Safari, Opera */
    -moz-opacity:0.30; /* FireFox */
    z-index: 20;
    height: 100%;
    width: 100%;
    background-repeat:no-repeat;
    background-position:center;
    position:absolute;
    top: 0px;
    left: 0px;
}
</style>
{%endblock extra_head%}
{% block page-plan-content %}
<div id="darkLayer" class="darkClass" style="display:none"></div>
<div class="row-fluid">						
	<div>
		<div id="step1" class="tab-pane">
			<legend>Barcoding</legend>
			<label class="radio inline">
                <input type="hidden" name="fireValidation" value="{{step.prepopulatedFields.fireValidation}}"/>
                <input type="hidden" name="irDown" value="0"/>
                <input type="hidden" name="applicationType"/>
				<input type="radio" id="chk_is_barcoded" name="is_barcoded" value="1" {%if helper.isBarcoded%}checked{%endif%}> Use Barcoding
			</label>
			<label class="radio inline">
				<input type="radio" id="ch_no_barcoding" name="is_barcoded" value="0" {%if not helper.isBarcoded%}checked{%endif%}> No Barcoding - One Sample per Chip
			</label>	
			<br><br>
			<div class="row-fluid">
				<div class="span6">
					<label>Barcoding Kit:</label>
					<select id="barcodingKit" name="barcodeId">
						<option value=""></option>
						{% for barcode in step.getPrePopulatedFieldDict.barcodes %}  
                    		<option value="{{barcode.name}}" 
                    			{%ifequal step.getCurrentSavedFieldDict.barcodeId barcode.name%}
                    				selected="true" 
                    			{%endifequal%}>{{barcode.name}}</option>
            			{% endfor %}
					</select>     									
				</div>
			</div>
            {% ifnotequal helper.getStepDict.Ionreporter.getCurrentSavedFieldDict.irAccountId "0" %}
			<div class="row-fluid">
				<div class="span6">
					<div>
						<label  style="float:left;" id="loading">Retrieving workflows...&nbsp;<img src="/site_media/img/loading.gif" width="35" height="35" /></label>
                		<label  style="float:left;">
                			Refresh workflows...&nbsp;
                			<a title="Refresh Plugin IonReporterUploader Information" class="refresh-uploader-information"><i class="icon-refresh"></i></a>
                		</label>
            		</div>

				</div>
                <div id="irerror" style="font-weight:bold;color:red;"></div>
			</div>
            {%endifnotequal%}
			<div class="k-grid k-widget" style="height: 500px;overflow:auto;">
				<table id="chipsets" data-role="grid" cellspacing="0" role="grid" style="height: auto;width:150%">
					<colgroup><col><col><col><col><col><col><col><col><col></colgroup>
					<thead class="k-grid-header">
						<tr>
                            <th width="50" class="k-header" data-field="SampleID" data-role="sortable" style="{%ifequal helper.getStepDict.Ionreporter.getCurrentSavedFieldDict.irAccountId "0"%}display:none;{%endifequal%}">
                                <a class="k-link" href="#">Row #</a>
                            </th>
							<th id="thChip" width="75" class="k-header" data-field="Chip" data-role="sortable" {%if helper.isBarcoded%}style="display:none;"{%endif%}>
								<a class="k-link" href="#">Chip #</a>
							</th>
							<th width="225" class="k-header" data-field="SampleID" data-role="sortable">
								<a class="k-link" href="#">Sample Name</a>
							</th>
							<th width="150" class="k-header" data-field="SampleName" data-role="sortable">
								<a class="k-link" href="#">Sample ID</a>
							</th>
							<th width="200" class="k-header" data-field="SampleDescription" data-role="sortable">
								<a class="k-link" href="#">Sample Description</a>
							</th>
							<th width="225" style="display:{%if not helper.isBarcoded%}none;{%endif%}" class="k-header" data-field="Barcode" data-role="sortable">
								<a class="k-link" href="#">Barcode</a>
							</th>
							<th width="100" style="display:{%if not helper.isBarcoded%}none;{%endif%}" class="k-header" data-field="Sequence" data-role="sortable">
								<a class="k-link" href="#">Sequence</a>
							</th>
                            {% ifnotequal helper.getStepDict.Ionreporter.getCurrentSavedFieldDict.irAccountId "0" %}
                            <th width="225" class="k-header" data-field="IRWorkflow" data-role="sortable">
                                <a class="k-link" href="#">IR Workflow</a>
                            </th>
							<th width="150" class="k-header" data-field="Role" data-role="sortable">
								<a class="k-link" href="#">Role</a>
							</th>
							<th width="100" class="k-header" data-field="Gender" data-role="sortable">
								<a class="k-link" href="#">Gender</a>
							</th>
							<th width="50" class="k-header" data-field="IRWorkflow" data-role="sortable">
								<a class="k-link" href="#" rel="tooltip" title="After file transfer, in Ion Reporter Software, samples with the same Set ID are considered related samples and are launched in the same analysis, such as a normal sample and its corresponding tumor samples. Do not give unrelated samples the same Set ID value (even if that value is zero or blank).">Set ID</a>
							</th>
                            {%endifnotequal%}
						</tr>
					</thead>
					<tbody>
                    {%if helper.isBarcoded %}
						{%for dnabarcode_id_str, values in step.savedObjects.barcodeToSample.items%}
							<tr>
                                <td width="225" role="gridcell" style="{%ifequal helper.getStepDict.Ionreporter.getCurrentSavedFieldDict.irAccountId "0"%}display:none;{%endifequal%}">
                                    {{forloop.counter}}
                                </td>
								<td role="gridcell" style="display:none;">
									<input type="text" class="input-mini" disabled style="width:30px;" value="{{forloop.counter}}" name="chipNumber{{forloop.counter0}}">
								</td>
								<td role="gridcell">
									<select name="sampleName{{forloop.counter0}}" class="irSampleName">
										<option value=""></option>
										{%for samplesetitem in step.prepopulatedFields.samplesetitems %}
											<option {%ifequal values.sampleName samplesetitem.sample.displayedName%}selected="true"{%endifequal%} value="{{samplesetitem.sample.displayedName}}">{{samplesetitem.sample.displayedName}}</option>
										{%endfor%}
									</select>  
								</td>
								<td role="gridcell">
									{{values.sampleExternalId}}
									<input type="hidden" name="sampleExternalId{{forloop.counter0}}" value="{{values.sampleExternalId}}"/>
								</td>
								<td role="gridcell">
									{{values.sampleDescription}}
									<input type="hidden" name="sampleDescription{{forloop.counter0}}" value="{{values.sampleDescription}}"/>
								</td>
								<td role="gridcell">
									<select name="sampleBarcode{{forloop.counter0}}" class="barcodeId">
										<option value=""></option>
										{%for barcodeitem in step.prepopulatedFields.planned_dnabarcodes %}
												<option value="{{barcodeitem.id_str}}" {%ifequal values.barcodeId barcodeitem.id_str%} selected="true" {%endifequal%} data-sequence="{{barcodeitem.sequence}}">{{barcodeitem.id_str}}</option>
										{%endfor%}
									</select>     									
								</td>
								<td role="gridcell">
									{%for barcodeitem in step.prepopulatedFields.planned_dnabarcodes %}
										{%ifequal values.barcodeId barcodeitem.id_str%}
											{{barcodeitem.sequence}}
										{%endifequal%}
									{%endfor%}
								</td>
                                <td role="gridcell">
                                    <select class="irWorkflow" name="workflow{{forloop.counter0}}"></select>     
                                    <input type="hidden" name="relation{{forloop.counter0}}" class="irRelation"/>   
                                </td>
								<td role="gridcell">
									<select style="width:150px;" class="irRelationRole" name="relationRole{{forloop.counter0}}"></select>
								</td>
								<td role="gridcell">
									<select style="width:90px;" class="irGender" name="gender{{forloop.counter0}}"></select>
								</td>
								<td role="gridcell">
									<input style="width:30px;" name="irSetID{{forloop.counter0}}" value="{{values.irSetID}}" style="width:40px;" class="irSetID">		
								</td>
							</tr>
						{%endfor%}
                    {%else%}
                        {%for chip, values in step.savedObjects.chipToSample.items%}
                            <tr>
                                <td width="225" role="gridcell" style="{%ifequal helper.getStepDict.Ionreporter.getCurrentSavedFieldDict.irAccountId "0"%}display:none;{%endifequal%}">
                                    {{forloop.counter}}
                                </td>
                                <td role="gridcell">
                                    <input type="text" class="input-mini" style="width:30px;" value="{{values.chipNumber}}" name="chipNumber{{forloop.counter0}}" disabled>
                                </td>
                                <td role="gridcell">
                                    <select name="sampleName{{forloop.counter0}}" class="irSampleName">
                                        <option value=""></option>
                                        {%for samplesetitem in step.prepopulatedFields.samplesetitems %}
                                            <option {%ifequal values.sampleName samplesetitem.sample.displayedName%}selected="true"{%endifequal%} value="{{samplesetitem.sample.displayedName}}">{{samplesetitem.sample.name}}</option>
                                        {%endfor%}
                                    </select>  
                                </td>
                                <td role="gridcell">
                                    {{values.sampleExternalId|default_if_none:""}}
                                    <input type="hidden" name="sampleExternalId{{forloop.counter0}}" value="{{values.sampleExternalId|default_if_none:""}}"/>
                                </td>
                                <td role="gridcell">
                                    {{values.sampleDescription|default_if_none:""}}
                                    <input type="hidden" name="sampleDescription{{forloop.counter0}}" value="{{values.sampleDescription|default_if_none:""}}"/>
                                </td>
                                <td role="gridcell" style="display:{%if not helper.isBarcoded%}none;{%endif%}">
                                    <select name="sampleBarcode{{forloop.counter0}}" class="barcodeId">
                                        <option value=""></option>
                                    </select>                                       
                                </td>
                                <td role="gridcell" style="display:{%if not helper.isBarcoded%}none;{%endif%}">
                                </td>
                                <td role="gridcell">
                                    <select class="irWorkflow" name="workflow{{forloop.counter0}}"></select> 
                                    <input type="hidden" name="relation{{forloop.counter0}}" class="irRelation"/>        
                                </td>
                                <td role="gridcell">
                                    <select style="width:150px;" class="irRelationRole" name="relationRole{{forloop.counter0}}"></select>
                                </td>
                                <td role="gridcell">
                                    <select style="width:90px;" class="irGender" name="gender{{forloop.counter0}}"></select>
                                </td>
                                <td role="gridcell">
                                    <input style="width:30px;" name="irSetID{{forloop.counter0}}" value="{{values.irSetID}}" style="width:40px;" class="irSetID">       
                                </td>
                            </tr>
                        {%endfor%}
                    {%endif%}
					</tbody>		
				</table>
                <div>
                {% ifequal helper.getStepDict.Ionreporter.getCurrentSavedFieldDict.irAccountId "0" %}
                    {%for samplesetitem in step.prepopulatedFields.samplesetitems %}
                        <input type="hidden" name="gender{{forloop.counter0}}" value="{{samplesetitem.gender}}"/>
                        <input type="hidden" name="relationRole{{forloop.counter0}}" value="{{samplesetitem.relationshipRole}}"/>
                    {%endfor%}
                {%endifequal%}
                </div>
			</div>								
		</div>
	</div>
</div>
<div class="row-fluid">
    {% for key, value in step.validationErrors.items %}
        {%for v in value %}
            <h4 style="color: red">{{v}}</h4>
        {%endfor%}
        
        
    {% endfor %}

</div>
<div class="row-fluid">
        <div id="error" style="color:red;font-weight:bold;"></div>
</div>
{%endblock%}
{% block prevnext-buttons %}
    
    
    <a class="btn btn-100" href="#" onclick="$('#step_form').attr('action', '{% url "page_plan_plugins" %}');$('#step_form').submit();return false;">&larr; Previous</a>
    <a class="btn btn-primary btn-100 pull-right" href="#" onclick="$('#step_form').attr('action', '{% url "page_plan_output" %}');$('#step_form').submit();return false;">Next &rarr;</a>&nbsp;&nbsp;<img id="loading1" src="/site_media/img/loading.gif" width="35" height="35" style="display:none;"/>
    
{% endblock prevnext-buttons %}
{% block summary-table %}
    {%include "rundb/plan/page_plan/summary/uploader_summary.html"%}
{% endblock summary-table %}
{% block post-raw %}
{{ block.super }}
<script type="text/javascript">

	var irGenderSelects;
    var irWorkflowSelects;
    var irRelationRoleSelects;
    var irSetIDInputs;

    var type_to_relation_map = {};
    var sample_group_to_workflow_map = {};
    var ir_sample_to_tss_sample = {};
    var default_samples = [];
    var workflow_to_application_type_map = {};

    var sample_to_barcode_map = {};

    {%if helper.isBarcoded %}
        {% for barcode, sampleValues in step.savedObjects.barcodeToSample.items %}
            {%if sampleValues.sampleName%}
                {%for barcodeitem in step.prepopulatedFields.planned_dnabarcodes %}
                    {%ifequal sampleValues.barcodeId barcodeitem.id_str%} 
                        sample_to_barcode_map["{{sampleValues.sampleName}}"] = "{{barcodeitem.id_str}}";
                    {%endifequal%}
                {%endfor%}
            {%endif%}
        {%endfor%}
    {%else%}
        {% for chip, sampleValues in step.savedObjects.chipToSample.items %}
            {%if sampleValues.sampleName%}
                {%for barcodeitem in step.prepopulatedFields.planned_dnabarcodes %}
                    {%ifequal sampleValues.barcodeId barcodeitem.id_str%} 
                        sample_to_barcode_map["{{sampleValues.sampleName}}"] = "{{barcodeitem.id_str}}";
                    {%endifequal%}
                {%endfor%}
            {%endif%}
        {%endfor%}
    {%endif%}

    

	function add_ir_general_to_select(name, values, invalid_value, old_values) {
        var $selects = $(".ir"+name+"");
        $.each($selects, function(j){
            var $select = $(this);
            $select.append($("<option></option>"));
            $.each(values, function(k){
                if (name == "Workflow") {
                    var value = values[k];    
                } else {
                    //TODO: might need to change this tookip value in a map
                    var value = values[k];
                }
                var $opt = $("<option></option>");
                $opt.attr('value', value);
                $opt.text(value);
                if (value == "{{helper.getStepDict.Ionreporter.getCurrentSavedFieldDict.irworkflow}}") {
                    $opt.attr('selected', true);
                }
                $select.append($opt);
            });
        });    
    }


    function set_invalid_value(restrictions) {
    	var  invalid_value;
    	$.each(restrictions, function(i){
    		var restriction = restrictions[i];
    		if (typeof restriction["Disabled"] != 'undefined' && restriction["For"]["Name"] == 'RelationShipType') {
    			invalid_value = restriction["For"]["Value"];
    		}
    	});

    	return invalid_value;
    }

    function add_ir_user_input(values, name, restrictions, default_rel_role_values) {
        if (typeof values != 'undefined') {
            if (name == "Relation"){
                default_rel_role_values = values;
            } else {
                var invalid_value = set_invalid_value(restrictions);
                add_ir_general_to_select(name, values, invalid_value);
            }
        }

        return default_rel_role_values;
    }

    function populate_sample_grouping_to_workflow_map(data) {
        var column_map = data["sampleRelationshipsTableInfo"]["column-map"];
        var restrictions = data["sampleRelationshipsTableInfo"]["restrictionRules"];

        $.each(column_map, function(i){
            var cm = column_map[i];
            var workflow = cm["Workflow"];
            var relationshipType = cm["RelationshipType"];
            workflow_to_application_type_map[workflow] = cm["ApplicationType"];
            $.each(restrictions, function(j){
                var restriction = restrictions[j];
                if (typeof restriction["For"] != 'undefined') {
                    if (restriction["For"]["Name"] == 'RelationshipType' && restriction["For"]["Value"] == relationshipType) {
                        
                            sample_group_to_workflow_map[workflow] = {};
                            sample_group_to_workflow_map[workflow]["relationshipType"] = restriction["For"]["Value"]
                            sample_group_to_workflow_map[workflow]["relationRoles"] = restriction["Valid"]["Values"];
                        
                    }
                }
            });

        });
    }

    function preset_ir_fields(counter, irSampleName, irGender, irWorkflow, irRelationRole, irSetID) {
        var $genderSelect = $(irGenderSelects[counter]);
        var $workflowSelect = $(irWorkflowSelects[counter]);
        var $relationRoleSelect = $(irRelationRoleSelects[counter]);
        var $irSetIDInput = $(irSetIDInputs[counter]);
        
        if (irGender.length > 0) {
            var irGenderTerms = ir_sample_to_tss_sample[irGender];
            
            if (irGenderTerms.length > 1) {
                irGender = irGenderTerms[1];
            } else {
                irGender = irGenderTerms[0];
            }

            // $genderSelect.find("option[value="+irGender+"]").attr('selected', true);

            var matchingGender = $genderSelect.find("option").filter(function () { 
                                    return this.value.toLowerCase() == irGender.toLowerCase(); 
                                } ).attr('value');    
            $genderSelect.val(matchingGender); 

        }
        

        

        if (irSampleName != '') {
            $workflowSelect.find("option[value='"+irWorkflow+"']").attr('selected', true);        
        } else {
            $workflowSelect.find("option[value='{{helper.getStepDict.Ionreporter.getCurrentSavedFieldDict.irworkflow}}']").attr('selected', true);
        }

        $workflowSelect.change();

        if (irRelationRole.length > 0) {
            var irRelationRoleTerms = ir_sample_to_tss_sample[irRelationRole];
            if (typeof irRelationRoleTerms != 'undefined') {
            
                $.each(irRelationRoleTerms, function(i){
                    var irRelationRole1 = irRelationRoleTerms[i];

                    // $relationRoleSelect.find("option[value="+irRelationRole1+"]").attr('selected', true);
                    var matchingRole = $relationRoleSelect.find("option").filter(function () { 
                                    return this.value.toLowerCase() == irRelationRole1.toLowerCase(); 
                                } ).attr('value');    
                    $relationRoleSelect.val(matchingRole);
                
                });
            } else {
                // $relationRoleSelect.find("option[value="+irRelationRole+"]").attr('selected', true);
                var matchingRole = $relationRoleSelect.find("option").filter(function () { 
                                    return this.value.toLowerCase() == irRelationRole.toLowerCase(); 
                                } ).attr('value');    
                $relationRoleSelect.val(matchingRole);
            }
                
            
        } else {
            $relationRoleSelect.find("option:eq(0)").attr('selected', true);
        }

        $irSetIDInput.val(irSetID);
    }

    function add_relation_roles($select, default_rel_role_values, invalid_value) {
    	var $tr = $select.parent().parent();
    	
    	var $ir_select = $tr.find(".irRelationRole");
    	$ir_select.empty();
    	$ir_select.append("<option></option>");

    	var values;

    	if (typeof sample_group_to_workflow_map[$select.val()] != 'undefined') {
    		values = sample_group_to_workflow_map[$select.val()];
    	} else {
    		values = default_rel_role_values;
    	}


    	$.each(values, function(i) {
    		if (values[i] != invalid_value) {
    			var $opt = $("<option></option>");
    			$opt.attr('value', values[i]);
    			$opt.text(values[i]);
    			$ir_select.append($opt);
    		}
    	});
    }

    function populate_relation_role(default_rel_role_values, invalid_value) {

    	irWorkflowSelects = $(".irWorkflow");

    	$.each(irWorkflowSelects, function(i){
    		var $select = $(irWorkflowSelects[i]);
    		add_relation_roles($select, default_rel_role_values, invalid_value);

    	});

    	irWorkflowSelects.on('change', function(){
    		add_relation_roles($(this), default_rel_role_values, invalid_value);
    	});
    }

    function set_relationroles_from_workflow($relationRole, relationRoles, workflow) {
        $relationRole.empty();

        $relationRole.append($("<option></option>"));

        var validRelationRolesTerms = sample_group_to_workflow_map[workflow];

        if (typeof validRelationRolesTerms != 'undefined') {
            $.each(validRelationRolesTerms, function(k, v){
                if (k == "relationRoles") {
                    var relationRole = v;

                    $.each(relationRole, function(j){
                        var $opt = $("<option></option>");
                        $opt.val(relationRole[j]);
                        $opt.text(relationRole[j]);
                        $relationRole.append($opt);    
                    });
                }
            });
        }
    }

    function find_relationship_type(workflow, columns_map) {
        var relationshipType = "";
        $.each(columns_map, function(i){
            var column = columns_map[i];
            if (column["Workflow"] == workflow) {
                relationshipType = column["RelationshipType"];
            }
        });
        return relationshipType;
    }

    function set_relationshiptype_from_workflow($relationshipType, relationshipType) {
        $relationshipType.empty();

        $relationshipType.append($("<option></option>"));

        var $opt = $("<option></option>");

        $opt.val(relationshipType);
        $opt.text(relationshipType);

        $relationshipType.append($opt);

    }



 	function load_and_set_ir_fields() {
        var user_input_url = "/rundb/api/v1/plugin/IonReporterUploader/extend/userInput/";
            
            var jqhxhr = $.get(user_input_url, {"format" : "json", "id" : "{{helper.getStepDict.Ionreporter.getCurrentSavedFieldDict.irAccountId}}"}, function(data){

            	if (typeof data["sampleRelationshipsTableInfo"] == 'undefined') {
                    
            		$("#loading").hide();
            		$("#irerror").text("Cannot contact Ion Reporter Server!");
                    $("input[name=irDown]").val('1');
                    // $("#selectedIR").text("None");
                    $rows = $("#chipsets tbody tr");
                    $ths = $("#chipsets thead tr");

                    $.each($rows, function(i) {
                        var $row = $(this);
                        $row.find("td:gt(6)").hide();
                    });

                    $.each($ths, function(i){
                        var $th = $(this);
                        $th.find("th:gt(6)").hide();
                    });
            		return;
            	}
            	
            	$("#error").text("");

                populate_sample_grouping_to_workflow_map(data);
                $("input[name=applicationType]").val(workflow_to_application_type_map['{{helper.getStepDict.Ionreporter.getCurrentSavedFieldDict.irworkflow}}']);

                var columns = data["sampleRelationshipsTableInfo"]["columns"];
                var restrictions = data["sampleRelationshipsTableInfo"]["restrictionRules"];
                var default_rel_role_values = {};
            
                if (typeof columns != 'undefined') {

                    $("#error").text("");
                    $("input[name=irDown]").val('0');
                    var invalid_value = set_invalid_value(restrictions);

                    $.each(columns, function(i){
                        var result = columns[i];
                        var name = result["Name"];
                        var values = result["Values"];
                        default_rel_role_values = add_ir_user_input(values, name, restrictions, default_rel_role_values);
                    });
                    
                    // populate_relation_role(default_rel_role_values, set_invalid_value(restrictions));

                    irGenderSelects = $(".irGender");

                    irGenderSelects.on('change', function(){
                        var flag = true;
                        {% for key, value in step.validationErrors.items %}
                            flag = false;
                        {%endfor%}
                        if ($("input[name=fireValidation]").val() == "0" && flag) {
                            $("input[name=fireValidation]").val("1");
                        }
                    });

                    irWorkflowSelects = $(".irWorkflow");
                    irRelationRoleSelects = $(".irRelationRole");
                    irRelationRoleSelects.on('change', function(){
                        var flag = true;
                        {% for key, value in step.validationErrors.items %}
                            flag = false;
                        {%endfor%}
                        if ($("input[name=fireValidation]").val() == "0" && flag) {
                            $("input[name=fireValidation]").val("1");
                        }
                    });
                    irSetIDInputs = $(".irSetID"); 

                    irWorkflowSelects.on('change', function(){
                        var flag = true;
                        {% for key, value in step.validationErrors.items %}
                            flag = false;
                        {%endfor%}
                        
                        var $tr = $(this).parent().parent();
                        var $relationshipType = $tr.find(".irRelation");
                        var $relationRole = $tr.find(".irRelationRole");
                        
                        var workflow = $(this).val();
                        var workflow_map = sample_group_to_workflow_map[workflow];


                        if (typeof workflow_map != 'undefined') {
                            
                            var relationshipType = workflow_map["relationshipType"];
                            var relationRoles = workflow_map["relationRoles"];

                            $(this).next().val(workflow_map['relationshipType']);

                            set_relationshiptype_from_workflow($relationshipType, relationshipType);

                            if (relationshipType != invalid_value) {
                                $relationRole.attr('disabled', false);
                                set_relationroles_from_workflow($relationRole, relationRoles, workflow);    
                            } else {
                                $relationRole.empty();
                                $relationRole.attr('disabled', true);
                            }
                            

                        } else {
                            var relationshipType = find_relationship_type(workflow, data["sampleRelationshipsTableInfo"]["column-map"]);
                            set_relationshiptype_from_workflow($relationshipType, relationshipType);

                            if (relationshipType != invalid_value) {
                                $relationRole.attr('disabled', false);
                                
                                set_relationroles_from_workflow($relationRole, default_rel_role_values, workflow);

                            } else {
                                $relationRole.empty();
                                $relationRole.attr('disabled', true);
                            }
                                                        
                        }
                    });
                    irWorkflowSelects.change();               
                    

                    {%if helper.isBarcoded %}
                        {% for barcode, sampleValues in step.savedObjects.barcodeToSample.items %}
                            preset_ir_fields({{forloop.counter0}}, "{{sampleValues.sampleName|default_if_none:""}}","{{sampleValues.gender|default_if_none:""}}", "{{sampleValues.workflow|default_if_none:""}}", "{{sampleValues.relationRole|default_if_none:""}}", "{{sampleValues.irSetID|default_if_none:""}}");
                        {%endfor%}
                    {%else%}
                        {% for chip, sampleValues in step.savedObjects.chipToSample.items %}
                            preset_ir_fields({{forloop.counter0}}, "{{sampleValues.sampleName|default_if_none:""}}","{{sampleValues.gender|default_if_none:""}}", "{{sampleValues.workflow|default_if_none:""}}", "{{sampleValues.relationRole|default_if_none:""}}", "{{sampleValues.irSetID|default_if_none:""}}");

                        {%endfor%}
                    {%endif%}
                } 
                
                $("#loading").hide();
            
        }, "json").fail(function(){
            $("#error").text("Could not contact the IonReporter server");
            $("#loading").hide();
        });
    }

    function submitSampleSetForm() {
            if ($("#chk_is_barcoded").is(":checked")) {
                if ($("#barcodingKit").val() == '') {
                    $("#irerror").text("Please select a barcoding kit");
                    return false;
                }
            }
            if ($("form").attr('action') == '{% url "page_plan_by_sample_barcode" %}') {return true;}
            // if ($("input[name=fireValidation]").val() == "0") {return true;}
            {%ifnotequal helper.getStepDict.Ionreporter.getCurrentSavedFieldDict.irAccountId "0"%}
                    // $.blockUI();
                    var counter = 1;
                    var inputData = {};
                    
                    var badRelation = false;
                    var $rows = $("#chipsets tbody tr");
                    
                    $.each($rows, function(i){
                            
                        var $tr = $(this);
                        var sampleNameSelect = $tr.find(".irSampleName");
                        if (sampleNameSelect.val() != '') {
                            inputData["counter"+counter] = {};
                            
                            var irWokflow = $tr.find(".irWorkflow").val();
                            
                            if (irWokflow == '') {badRelation = true; $("#loading1").hide();return false;}

                            inputData["counter"+counter]["relation"] = $tr.find(".irRelation").val();
                            inputData["counter"+counter]["row"] = counter.toString();
                            inputData["counter"+counter]["sampleName"] = sampleNameSelect.val();
                            inputData["counter"+counter]["workflow"] = $tr.find(".irWorkflow").val();
                            inputData["counter"+counter]["gender"] = $tr.find(".irGender").val();
                            inputData["counter"+counter]["relationRole"] = $tr.find(".irRelationRole").val();
                            inputData["counter"+counter]["irSetID"] = $tr.find(".irSetID").val();
                            {%if helper.isBarcoded%}
                                inputData["counter"+counter]["barcodeId"] = $tr.find(".irSetID").val();
                            {%endif%}

                        }
                        counter++;
                    });

                    if (badRelation) {
                        $("#errors").text("Workflow on row " + counter + " cannot be blank");
                        return false;
                    }

                    flag = validate_user_input_from_iru($("form"), "{{helper.getStepDict.Ionreporter.getCurrentSavedFieldDict.irAccountId}}", "{{helper.getStepDict.Ionreporter.getCurrentSavedFieldDict.irAccountName}}", inputData);
                    return flag;
                    
            {%else%}
                return true;
            {%endifnotequal%}
        }

    $(document).ready(function () {
        $(document).ajaxStart($.blockUI).ajaxStop($.unblockUI);
        {%comment%} some javascript functions are no longer used, and need cleanup {%endcomment%}
    	var barcodekits = {};
    	var samplesetmap = {};
        var all_barcodes = {};

        {% ifnotequal helper.getStepDict.Ionreporter.getCurrentSavedFieldDict.irAccountId "0" %}
    	   load_and_set_ir_fields();
        {%else%}
            $(".irGender").hide();
            $(".irWorkflow").hide();
            $(".irRelationRole").hide();
            $(".irSetID").hide(); 
        {%endifnotequal%}

        
    	{%for barcodekit in step.prepopulatedFields.barcodekits %}
    	   barcodekits['{{barcodekit.name}}'] = {{barcodekit.barcodes|safe}};
    	{%endfor%}


    	{%for samplesetitem in step.prepopulatedFields.samplesetitems %}
    		samplesetmap['{{samplesetitem.sample.displayedName}}'] = {
    			'sampleid' : "{{samplesetitem.sample.externalId}}",
    			'description' : "{{samplesetitem.sample.description}}",
    			'gender' : "{{samplesetitem.gender}}",
    			'relationshipRole' : "{{samplesetitem.relationshipRole}}"
    			}
    	{%endfor%}

        {%for sample_annotation in step.prepopulatedFields.sampleAnnotations %}
            var ir_term = "{{sample_annotation.iRValue}}";
            var ir_terms = ir_term.split("|");
            $.each(ir_terms, function(i) {
                var term = ir_terms[i];
                if (typeof ir_sample_to_tss_sample["{{sample_annotation.value}}"] == 'undefined') {
                    ir_sample_to_tss_sample["{{sample_annotation.value}}"] = []
                }
                ir_sample_to_tss_sample["{{sample_annotation.value}}"].push(term);
                // if ($.inArray("{{sample_annotation.value}}", default_samples) == -1) {
                //     default_samples.push("{{sample_annotation.value}}");
                // }
            });
        {%endfor%}

    	$("select").filter(function(){return this.name.match(/sampleBarcode\d/)}).on('change', function(){
    		var $td = $(this).parent();
    		var $seq_td = $td.next();

    		var $option = $(this).find(":selected");
    		$seq_td.html($option.data('sequence'));
    	});

    	$("select").filter(function(){return this.name.match(/sampleName\d/)}).on('change', function(){
    		var counter = $(this).attr('name').replace('sampleName', '');
    		var $td = $(this).parent();
    		var $sampleid_td = $td.next();
    		var $description_td = $sampleid_td.next();
    		// var $role_td = $description_td.next().next().next();
    		// var $gender_td = $role_td.next();

    		$sampleid_td.empty();
    		$description_td.empty();
    		// $role_td.empty();
    		// $gender_td.empty();
    		

    		if ($(this).val() != '') {
	    		var sampleset = samplesetmap[$(this).val()];	
	    	
    			$sampleid_td.text(sampleset['sampleid']);
    			$sampleid_td.append($("<input type='hidden'>").attr({'name' : 'sampleExternalId'+counter , 'value' : sampleset['sampleid'] }));
    			$description_td.text(sampleset['description']);
    			$description_td.append($("<input type='hidden'>").attr({'name' : 'sampleDescription'+counter , 'value' : sampleset['description'] }));
    			// $role_td.html(sampleset['relationshipRole']);
    			// $gender_td.html(sampleset['gender']);
	    	} else {

	    		$sampleid_td.append($("<input type='hidden'>").attr({'name' : 'sampleExternalId'+counter , 'value' : ''}));
	    	}

    	});

        

    	$("#barcodingKit").on('change', function(){
            if ($("#ch_no_barcoding").is(":checked")) {
                $(this).val('');
                return;
            }
            $("#error").text("");
            var dnabarcodes = barcodekits[$(this).val()];
            var $rows = $("#chipsets tbody tr");
            var $tbody = $("#chipsets tbody");
            var self;
            var $td;
            var $select;
            var $sequence_td;
            $.each(dnabarcodes, function(i){
                if ($("#thChip").length > 0) {
                    $("#thChip").hide();
                }

                if (i < $rows.length) {
                    self = $("#chipsets tbody tr:eq("+i+")");   
                    // self.find("td").eq('0');
                    $td = self.find('td').eq('5');
                    $select = $td.find('select');
                    $sequence_td = $td.next();
                
                } else {
                    var $last_tr = $("#chipsets tbody tr:last-child");
                    var $tr = $("<tr></tr>");
                    var $rownumtd = $("<td></td>", {"role" : "gridcell"});
                    $rownumtd.text(i);
                    $tr.append($rownumtd);
                    {%ifequal helper.getStepDict.Ionreporter.getCurrentSavedFieldDict.irAccountId "0" %}
                        $rownumtd.hide();
                    {%endifequal%}
                    var $sample_name_td = $("<td></td>", {"role" : "gridcell"});
                    var $sample_name_select = $("<select></select>", {"name" : "sampleName"+i});
                    $sample_name_select.append($("<option></option>"));
                    $.each(samplesetmap, function(k,v){
                            $opt = $("<option></option>", {"value" : k});
                            $opt.text(k);
                            $sample_name_select.append($opt);

                        });

                    $sample_name_td.append($sample_name_select);
                    $tr.append($sample_name_td);

                    var $sample_external_id_td = $("<td></td>", {"role" : "gridcell"});
                    $tr.append($sample_external_id_td);

                    var $sample_description_td = $("<td></td>", {"role" : "gridcell"});
                    $tr.append($sample_description_td);


                    $sample_name_select.on('change', function(){
                        var counter = $(this).attr('name').replace('sampleName', '');
                        var $td = $(this).parent();
                        var $sampleid_td = $td.next();
                        var $description_td = $sampleid_td.next();
            
                        $sampleid_td.empty();
                        $description_td.empty();
            

                            if ($(this).val() != '') {
                                var sampleset = samplesetmap[$(this).val()];    
            
                                $sampleid_td.text(sampleset['sampleid']);
                                $sampleid_td.append($("<input type='hidden'>").attr({'name' : 'sampleExternalId'+counter , 'value' : sampleset['sampleid'] }));
                                $description_td.text(sampleset['description']);
                                $description_td.append($("<input type='hidden'>").attr({'name' : 'sampleDescription'+counter , 'value' : sampleset['description'] }));
                                // $role_td.html(sampleset['relationshipRole']);
                                // $gender_td.html(sampleset['gender']);
                            } else {

                                $sampleid_td.append($("<input type='hidden'>").attr({'name' : 'sampleExternalId'+counter , 'value' : ''}));
                            } 
                    });
                    

                    var $barcode_id_str_td = $("<td></td>", {"role" : "gridcell"});
                    var $barcode_id_str_select = $("<select></select>", {"name" : "sampleBarcode"+i});
                    $tr.append($barcode_id_str_td);
                    $barcode_id_str_td.append($barcode_id_str_select);

                    var $sequence_td = $("<td></td>", {"role" : "gridcell"});
                    $tr.append($sequence_td);

                    $last_tr.after($tr);

                    $td = $barcode_id_str_td;
                    $select = $td.find('select');
                    $sequence_td = $td.next();

                }
                
                $select.empty();
                $select.append($("<option></option>"));
                $.each(dnabarcodes, function(x){
                        var id_str = dnabarcodes[x]['id_str'];
                        var sequence = dnabarcodes[x]['sequence'];
                    
                        var $option = $("<option></option>").attr({'value' : id_str}).text(id_str);
                        $option.data('sequence', sequence);


                        
                        if (i == x) {
                            $option.attr('selected', true);
                        }
                        $select.append($option);

                });
                if ($("#barcodingKit").val() == "{{step.getCurrentSavedFieldDict.barcodeId}}"){
                    var $samplenameslect1 = $("select[name=sampleName"+i+"]");
                    if ($samplenameslect1.val().length > 0) {
                        id_str = sample_to_barcode_map[$samplenameslect1.val()];
                        if (typeof(id_str) != 'undefined') {
                            $select.find("option[value="+sample_to_barcode_map[$samplenameslect1.val()]+"]").attr('selected', true);
                        } else{
                            $select.val('');
                        }        
                    }
                }
                
                $sequence_td.html(dnabarcodes[i]['sequence']);  

            });

            if ($rows.length > dnabarcodes.length) {
                $("#chipsets tbody tr:gt("+(dnabarcodes.length-1)+")").remove();
            }
            
    	});

    	$("input[name=is_barcoded]").on('click', function(){

    		if ($(this).val() == '0') {
                var is_IR = "{{helper.getStepDict.Ionreporter.getCurrentSavedFieldDict.irAccountId}}";

                if (is_IR != "0") {
                    $("#chipsets thead tr th:eq(0)").show();
                    $("#chipsets tbody tr td:first-child").show();
                }
    			$("#chipsets thead tr th:eq(1)").show();
                $("#chipsets tbody tr td:nth-child(2)").show();

                $("#chipsets thead tr th:eq(5)").hide();
                $("#chipsets thead tr th:eq(6)").hide();

                $("#chipsets tbody tr td:nth-child(6)").hide();
                $("#chipsets tbody tr td:nth-child(7)").hide();

                var count = Object.keys(samplesetmap).length - 1;
                $("#chipsets tbody tr:gt("+count+")").show();

                $("#barcodingKit").val('');

                
                
                if (is_IR == "0") {
                    var count = $("#chipsets tbody tr").length;
                    
                    while (count < 20) {

                        var $last_tr = $("#chipsets tbody tr:last-child");
                        var $tr = $("<tr></tr>");

                        var $rownum_td = $("<td></td>", {"role" : "gridcell", "style" : "display:none;"});
                        $tr.append($rownum_td);

                        var $chipnum_td = $("<td></td>", {"role" : "gridcell"});
                        var $chipnum_input = $("<input/>", {
                            "type" : "text" , "class" : "input-mini",  "style" :"width:30px;",  "value" : count+1, "name":"chipNumber"+count, "disabled" : true
                        });
                        $chipnum_td.append($chipnum_input);

                        $tr.append($chipnum_td);

                        var $sample_name_td = $("<td></td>", {"role" : "gridcell"});
                        var $sample_name_select = $("<select></select>", {"name" : "sampleName"+count});
                        $sample_name_select.append($("<option></option>"));
                        $.each(samplesetmap, function(k,v){
                            $opt = $("<option></option>", {"value" : k});
                            $opt.text(k);
                            $sample_name_select.append($opt);

                        });

                        $sample_name_td.append($sample_name_select);
                        $tr.append($sample_name_td);

                        var $sample_external_id_td = $("<td></td>", {"role" : "gridcell"});
                        $tr.append($sample_external_id_td);

                        var $sample_description_td = $("<td></td>", {"role" : "gridcell"});
                        $tr.append($sample_description_td);


                        $sample_name_select.on('change', function(){
                            var counter = $(this).attr('name').replace('sampleName', '');
                            var $td = $(this).parent();
                            var $sampleid_td = $td.next();
                            var $description_td = $sampleid_td.next();
            
                            $sampleid_td.empty();
                            $description_td.empty();
            

                            if ($(this).val() != '') {
                                var sampleset = samplesetmap[$(this).val()];    
            
                                $sampleid_td.text(sampleset['sampleid']);
                                $sampleid_td.append($("<input type='hidden'>").attr({'name' : 'sampleExternalId'+counter , 'value' : sampleset['sampleid'] }));
                                $description_td.text(sampleset['description']);
                                $description_td.append($("<input type='hidden'>").attr({'name' : 'sampleDescription'+counter , 'value' : sampleset['description'] }));
                                // $role_td.html(sampleset['relationshipRole']);
                                // $gender_td.html(sampleset['gender']);
                            } else {

                                $sampleid_td.append($("<input type='hidden'>").attr({'name' : 'sampleExternalId'+counter , 'value' : ''}));
                            } 
                        });

                        $last_tr.after($tr);

                        count = $("#chipsets tbody tr").length;

                    
                    }
                } else {
                    $("#chipsets tbody tr:gt("+count+")").hide();  
                }

    		} else {
    			$("#chipsets thead tr th:eq(1)").hide();
    			$("#chipsets tbody tr td:nth-child(2)").hide();

                $("#chipsets thead tr th:eq(5)").show();
                $("#chipsets thead tr th:eq(6)").show();

                $("#chipsets tbody tr td:nth-child(6)").show();
                $("#chipsets tbody tr td:nth-child(7)").show();
                $("#chipsets tbody tr").show();


                var $select = $("#barcodingKit");
                $select.val('{{step.getCurrentSavedFieldDict.barcodeId}}');

                var dnabarcodes = barcodekits[$select.val()];
                var count = dnabarcodes.length - 1;
                $("#chipsets tbody tr:gt("+count+")").hide();
               
    		}
    	});

        

        $("form").submit(function(e){
            if ($("input[name=irDown]").val() == "1")
                return true;
            $.blockUI();
            var flag = false;
            setTimeout(function(){
                flag = submitSampleSetForm();
                if (flag === true) {
                    $("form").unbind("submit");
                    $("form").submit();
                } else if (flag === false){
                    $.unblockUI();
                    return false;
                }else {
                    apprise(flag, {
                        'confirm': false,       // Ok and Cancel buttons
                        'verify': true,     // Yes and No buttons
                        'input': false,         // Text input (can be true or string for default text)
                        'animate': true,    // Groovy animation (can true or number, default is 400)
                        'textOk': 'Ok',     // Ok button default text
                        'textCancel': 'Cancel', // Cancel button default text
                        'textYes': 'Ignore Errors',     // Yes button default text
                        'textNo': 'Fix Errors',     // No button default text
                        'position': 'center'// position center (y-axis) any other option will default to 100 top
                    }, function (r) {
                            if (r) {$("form").unbind("submit");$("form").submit();}
                            else {flag = false;}
                        }
                    );
                }
            },200);
            if (!flag)
                e.preventDefault();
        });
    });

</script>
{% endblock post-raw %}